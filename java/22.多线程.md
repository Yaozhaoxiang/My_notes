# å¤šçº¿ç¨‹

Javaè¯­è¨€å†…ç½®äº†å¤šçº¿ç¨‹æ”¯æŒï¼šä¸€ä¸ªJavaç¨‹åºå®é™…ä¸Šæ˜¯ä¸€ä¸ªJVMè¿›ç¨‹ï¼ŒJVMè¿›ç¨‹ç”¨ä¸€ä¸ªä¸»çº¿ç¨‹æ¥æ‰§è¡Œmain()æ–¹æ³•ï¼Œåœ¨main()æ–¹æ³•å†…éƒ¨ï¼Œæˆ‘ä»¬åˆå¯ä»¥å¯åŠ¨å¤šä¸ªçº¿ç¨‹ã€‚æ­¤å¤–ï¼ŒJVMè¿˜æœ‰è´Ÿè´£åƒåœ¾å›æ”¶çš„å…¶ä»–å·¥ä½œçº¿ç¨‹ç­‰ã€‚

å› æ­¤ï¼Œå¯¹äºå¤§å¤šæ•°Javaç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬è¯´å¤šä»»åŠ¡ï¼Œå®é™…ä¸Šæ˜¯è¯´å¦‚ä½•ä½¿ç”¨å¤šçº¿ç¨‹å®ç°å¤šä»»åŠ¡ã€‚

å’Œå•çº¿ç¨‹ç›¸æ¯”ï¼Œå¤šçº¿ç¨‹ç¼–ç¨‹çš„ç‰¹ç‚¹åœ¨äºï¼šå¤šçº¿ç¨‹ç»å¸¸éœ€è¦è¯»å†™å…±äº«æ•°æ®ï¼Œå¹¶ä¸”éœ€è¦åŒæ­¥ã€‚ä¾‹å¦‚ï¼Œæ’­æ”¾ç”µå½±æ—¶ï¼Œå°±å¿…é¡»ç”±ä¸€ä¸ªçº¿ç¨‹æ’­æ”¾è§†é¢‘ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ’­æ”¾éŸ³é¢‘ï¼Œä¸¤ä¸ªçº¿ç¨‹éœ€è¦åè°ƒè¿è¡Œï¼Œå¦åˆ™ç”»é¢å’Œå£°éŸ³å°±ä¸åŒæ­¥ã€‚å› æ­¤ï¼Œå¤šçº¿ç¨‹ç¼–ç¨‹çš„å¤æ‚åº¦é«˜ï¼Œè°ƒè¯•æ›´å›°éš¾ã€‚

Javaå¤šçº¿ç¨‹ç¼–ç¨‹çš„ç‰¹ç‚¹åˆåœ¨äºï¼š

+ å¤šçº¿ç¨‹æ¨¡å‹æ˜¯Javaç¨‹åºæœ€åŸºæœ¬çš„å¹¶å‘æ¨¡å‹ï¼›
+ åç»­è¯»å†™ç½‘ç»œã€æ•°æ®åº“ã€Webå¼€å‘ç­‰éƒ½ä¾èµ–Javaå¤šçº¿ç¨‹æ¨¡å‹ã€‚

## 1. åˆ›å»ºæ–°çº¿ç¨‹

Javaè¯­è¨€å†…ç½®äº†å¤šçº¿ç¨‹æ”¯æŒã€‚å½“Javaç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯å¯åŠ¨äº†ä¸€ä¸ªJVMè¿›ç¨‹ï¼Œç„¶åï¼ŒJVMå¯åŠ¨ä¸»çº¿ç¨‹æ¥æ‰§è¡Œmain()æ–¹æ³•ã€‚åœ¨main()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆå¯ä»¥å¯åŠ¨å…¶ä»–çº¿ç¨‹ã€‚

è¦åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹éå¸¸å®¹æ˜“ï¼Œæˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªThreadå®ä¾‹ï¼Œç„¶åè°ƒç”¨å®ƒçš„start()æ–¹æ³•ï¼š

```java
// å¤šçº¿ç¨‹
public class Main {
    public static void main(String[] args) {
        Thread t = new Thread();
        t.start(); // å¯åŠ¨æ–°çº¿ç¨‹ -> è°ƒç”¨run()
    }
}
```

ä½†æ˜¯è¿™ä¸ªçº¿ç¨‹å¯åŠ¨åå®é™…ä¸Šä»€ä¹ˆä¹Ÿä¸åšå°±ç«‹åˆ»ç»“æŸäº†ã€‚æˆ‘ä»¬å¸Œæœ›æ–°çº¿ç¨‹èƒ½æ‰§è¡ŒæŒ‡å®šçš„ä»£ç ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š

```java
// å¤šçº¿ç¨‹
public class Main {
    public static void main(String[] args) {
        Thread t = new MyThread();
        t.start(); // å¯åŠ¨æ–°çº¿ç¨‹
    }
}

class MyThread extends Thread {
    @Override
    public void run() {
        System.out.println("start new thread!");
    }
}

```

æ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œæ³¨æ„åˆ°start()æ–¹æ³•ä¼šåœ¨å†…éƒ¨è‡ªåŠ¨è°ƒç”¨å®ä¾‹çš„run()æ–¹æ³•ã€‚

æ–¹æ³•äºŒï¼šåˆ›å»ºThreadå®ä¾‹æ—¶ï¼Œä¼ å…¥ä¸€ä¸ªRunnableå®ä¾‹ï¼š

```java
// å¤šçº¿ç¨‹
public class Main {
    public static void main(String[] args) {
        Thread t = new Thread(new MyRunnable());
        t.start(); // å¯åŠ¨æ–°çº¿ç¨‹
    }
}

class MyRunnable implements Runnable {
    @Override
    public void run() {
        System.out.println("start new thread!");
    }
}

```

Runnable æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ªrunå‡½æ•°ï¼›Threadä¹Ÿå®ç°è¿™ä¸ªæ¥å£ï¼›
æ‰€ä»¥è¿™é‡Œä½¿ç”¨`Thread(Runnable task) `è¿™ä¸ªæ„é€ å‡½æ•°ï¼›

æˆ–è€…ç”¨Java 8å¼•å…¥çš„lambdaè¯­æ³•è¿›ä¸€æ­¥ç®€å†™ä¸ºï¼š

```java
// å¤šçº¿ç¨‹
public class Main {
    public static void main(String[] args) {
        Thread t = new Thread(() -> {
            System.out.println("start new thread!");
        });
        t.start(); // å¯åŠ¨æ–°çº¿ç¨‹
    }
}

```

çº¿ç¨‹çš„ä¼˜å…ˆçº§
å¯ä»¥å¯¹çº¿ç¨‹è®¾å®šä¼˜å…ˆçº§ï¼Œè®¾å®šä¼˜å…ˆçº§çš„æ–¹æ³•æ˜¯ï¼š

```java
Thread.setPriority(int n) // 1~10, é»˜è®¤å€¼5
```

JVMè‡ªåŠ¨æŠŠ1ï¼ˆä½ï¼‰~10ï¼ˆé«˜ï¼‰çš„ä¼˜å…ˆçº§æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿå®é™…ä¼˜å…ˆçº§ä¸Šï¼ˆä¸åŒæ“ä½œç³»ç»Ÿæœ‰ä¸åŒçš„ä¼˜å…ˆçº§æ•°é‡ï¼‰ã€‚ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹è¢«æ“ä½œç³»ç»Ÿè°ƒåº¦çš„ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œæ“ä½œç³»ç»Ÿå¯¹é«˜ä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½è°ƒåº¦æ›´é¢‘ç¹ï¼Œä½†æˆ‘ä»¬å†³ä¸èƒ½é€šè¿‡è®¾ç½®ä¼˜å…ˆçº§æ¥ç¡®ä¿é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¸€å®šä¼šå…ˆæ‰§è¡Œã€‚

## 2. çº¿ç¨‹çš„çŠ¶æ€

åœ¨Javaç¨‹åºä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹è±¡åªèƒ½è°ƒç”¨ä¸€æ¬¡start()æ–¹æ³•å¯åŠ¨æ–°çº¿ç¨‹ï¼Œå¹¶åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œrun()æ–¹æ³•ã€‚ä¸€æ—¦run()æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œçº¿ç¨‹å°±ç»“æŸäº†ã€‚å› æ­¤ï¼ŒJavaçº¿ç¨‹çš„çŠ¶æ€æœ‰ä»¥ä¸‹å‡ ç§ï¼š

+ Newï¼šæ–°åˆ›å»ºçš„çº¿ç¨‹ï¼Œå°šæœªæ‰§è¡Œï¼›
+ Runnableï¼šè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œæ­£åœ¨æ‰§è¡Œrun()æ–¹æ³•çš„Javaä»£ç ï¼›
+ Blockedï¼šè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œå› ä¸ºæŸäº›æ“ä½œè¢«é˜»å¡è€ŒæŒ‚èµ·ï¼›
+ Waitingï¼šè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œå› ä¸ºæŸäº›æ“ä½œåœ¨ç­‰å¾…ä¸­ï¼›
+ Timed Waitingï¼šè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œå› ä¸ºæ‰§è¡Œsleep()æ–¹æ³•æ­£åœ¨è®¡æ—¶ç­‰å¾…ï¼›
+ Terminatedï¼šçº¿ç¨‹å·²ç»ˆæ­¢ï¼Œå› ä¸ºrun()æ–¹æ³•æ‰§è¡Œå®Œæ¯•

ç”¨ä¸€ä¸ªçŠ¶æ€è½¬ç§»å›¾è¡¨ç¤ºå¦‚ä¸‹ï¼š

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     New     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚â”‚  Runnable   â”‚ â”‚   Blocked   â”‚â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
 â”‚   Waiting   â”‚ â”‚Timed Waitingâ”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
 â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Terminated  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


å½“çº¿ç¨‹å¯åŠ¨åï¼Œå®ƒå¯ä»¥åœ¨Runnableã€Blockedã€Waitingå’ŒTimed Waitingè¿™å‡ ä¸ªçŠ¶æ€ä¹‹é—´åˆ‡æ¢ï¼Œç›´åˆ°æœ€åå˜æˆTerminatedçŠ¶æ€ï¼Œçº¿ç¨‹ç»ˆæ­¢ã€‚

çº¿ç¨‹ç»ˆæ­¢çš„åŸå› æœ‰ï¼š

+ çº¿ç¨‹æ­£å¸¸ç»ˆæ­¢ï¼šrun()æ–¹æ³•æ‰§è¡Œåˆ°returnè¯­å¥è¿”å›ï¼›
+ çº¿ç¨‹æ„å¤–ç»ˆæ­¢ï¼šrun()æ–¹æ³•å› ä¸ºæœªæ•è·çš„å¼‚å¸¸å¯¼è‡´çº¿ç¨‹ç»ˆæ­¢ï¼›
+ å¯¹æŸä¸ªçº¿ç¨‹çš„Threadå®ä¾‹è°ƒç”¨stop()æ–¹æ³•å¼ºåˆ¶ç»ˆæ­¢ï¼ˆå¼ºçƒˆä¸æ¨èä½¿ç”¨ï¼‰ã€‚

ä¸€ä¸ªçº¿ç¨‹è¿˜å¯ä»¥ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹ç›´åˆ°å…¶è¿è¡Œç»“æŸã€‚ä¾‹å¦‚ï¼Œmainçº¿ç¨‹åœ¨å¯åŠ¨tçº¿ç¨‹åï¼Œå¯ä»¥é€šè¿‡t.join()ç­‰å¾…tçº¿ç¨‹ç»“æŸåå†ç»§ç»­è¿è¡Œï¼š

```java
// å¤šçº¿ç¨‹
public class Main {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new Thread(() -> {
            System.out.println("hello");
        });
        System.out.println("start");
        t.start(); // å¯åŠ¨tçº¿ç¨‹
        t.join(); // æ­¤å¤„mainçº¿ç¨‹ä¼šç­‰å¾…tç»“æŸ
        System.out.println("end");
    }
}

```

å½“mainçº¿ç¨‹å¯¹çº¿ç¨‹å¯¹è±¡tè°ƒç”¨join()æ–¹æ³•æ—¶ï¼Œä¸»çº¿ç¨‹å°†ç­‰å¾…å˜é‡tè¡¨ç¤ºçš„çº¿ç¨‹è¿è¡Œç»“æŸï¼Œå³joinå°±æ˜¯æŒ‡ç­‰å¾…è¯¥çº¿ç¨‹ç»“æŸï¼Œç„¶åæ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œè‡ªèº«çº¿ç¨‹ã€‚æ‰€ä»¥ï¼Œä¸Šè¿°ä»£ç æ‰“å°é¡ºåºå¯ä»¥è‚¯å®šæ˜¯mainçº¿ç¨‹å…ˆæ‰“å°startï¼Œtçº¿ç¨‹å†æ‰“å°helloï¼Œmainçº¿ç¨‹æœ€åå†æ‰“å°endã€‚

å¦‚æœtçº¿ç¨‹å·²ç»ç»“æŸï¼Œå¯¹å®ä¾‹tè°ƒç”¨join()ä¼šç«‹åˆ»è¿”å›ã€‚æ­¤å¤–ï¼Œjoin(long)çš„é‡è½½æ–¹æ³•ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªç­‰å¾…æ—¶é—´ï¼Œè¶…è¿‡ç­‰å¾…æ—¶é—´åå°±ä¸å†ç»§ç»­ç­‰å¾…ã€‚

## 3. ä¸­æ–­çº¿ç¨‹

å¦‚æœçº¿ç¨‹éœ€è¦æ‰§è¡Œä¸€ä¸ªé•¿æ—¶é—´ä»»åŠ¡ï¼Œå°±å¯èƒ½éœ€è¦èƒ½ä¸­æ–­çº¿ç¨‹ã€‚ä¸­æ–­çº¿ç¨‹å°±æ˜¯å…¶ä»–çº¿ç¨‹ç»™è¯¥çº¿ç¨‹å‘ä¸€ä¸ªä¿¡å·ï¼Œè¯¥çº¿ç¨‹æ”¶åˆ°ä¿¡å·åç»“æŸæ‰§è¡Œrun()æ–¹æ³•ï¼Œä½¿å¾—è‡ªèº«çº¿ç¨‹èƒ½ç«‹åˆ»ç»“æŸè¿è¡Œã€‚

æˆ‘ä»¬ä¸¾ä¸ªæ —å­ï¼šå‡è®¾ä»ç½‘ç»œä¸‹è½½ä¸€ä¸ª100Mçš„æ–‡ä»¶ï¼Œå¦‚æœç½‘é€Ÿå¾ˆæ…¢ï¼Œç”¨æˆ·ç­‰å¾—ä¸è€çƒ¦ï¼Œå°±å¯èƒ½åœ¨ä¸‹è½½è¿‡ç¨‹ä¸­ç‚¹â€œå–æ¶ˆâ€ï¼Œè¿™æ—¶ï¼Œç¨‹åºå°±éœ€è¦ä¸­æ–­ä¸‹è½½çº¿ç¨‹çš„æ‰§è¡Œã€‚

ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨å…¶ä»–çº¿ç¨‹ä¸­å¯¹ç›®æ ‡çº¿ç¨‹è°ƒç”¨interrupt()æ–¹æ³•ï¼Œç›®æ ‡çº¿ç¨‹éœ€è¦åå¤æ£€æµ‹è‡ªèº«çŠ¶æ€æ˜¯å¦æ˜¯interruptedçŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œå°±ç«‹åˆ»ç»“æŸè¿è¡Œã€‚

```java
// ä¸­æ–­çº¿ç¨‹
public class Main {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new MyThread();
        t.start();
        Thread.sleep(1); // æš‚åœ1æ¯«ç§’

        t.interrupt(); // ä¸­æ–­tçº¿ç¨‹
        t.join(); // ç­‰å¾…tçº¿ç¨‹ç»“æŸ
        System.out.println("end");
    }
}

class MyThread extends Thread {
    public void run() {
        int n = 0;
        while (! isInterrupted()) {
            n ++;
            System.out.println(n + " hello!");
        }
    }
}

```

ä»”ç»†çœ‹ä¸Šè¿°ä»£ç ï¼Œmainçº¿ç¨‹é€šè¿‡è°ƒç”¨t.interrupt()æ–¹æ³•ä¸­æ–­tçº¿ç¨‹ï¼Œä½†æ˜¯è¦æ³¨æ„ï¼Œinterrupt()æ–¹æ³•ä»…ä»…å‘tçº¿ç¨‹å‘å‡ºäº†â€œä¸­æ–­è¯·æ±‚â€ï¼Œè‡³äºtçº¿ç¨‹æ˜¯å¦èƒ½ç«‹åˆ»å“åº”ï¼Œè¦çœ‹å…·ä½“ä»£ç ã€‚è€Œtçº¿ç¨‹çš„whileå¾ªç¯ä¼šæ£€æµ‹isInterrupted()ï¼Œæ‰€ä»¥ä¸Šè¿°ä»£ç èƒ½æ­£ç¡®å“åº”interrupt()è¯·æ±‚ï¼Œä½¿å¾—è‡ªèº«ç«‹åˆ»ç»“æŸè¿è¡Œrun()æ–¹æ³•ã€‚

å¦‚æœçº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œt.join()ä¼šè®©mainçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œæ­¤æ—¶ï¼Œå¦‚æœå¯¹mainçº¿ç¨‹è°ƒç”¨interrupt()ï¼Œjoin()æ–¹æ³•ä¼šç«‹åˆ»æŠ›å‡ºInterruptedExceptionï¼Œå› æ­¤ï¼Œç›®æ ‡çº¿ç¨‹åªè¦æ•è·åˆ°join()æ–¹æ³•æŠ›å‡ºçš„InterruptedExceptionï¼Œå°±è¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å¯¹å…¶è°ƒç”¨äº†interrupt()æ–¹æ³•ï¼Œé€šå¸¸æƒ…å†µä¸‹è¯¥çº¿ç¨‹åº”è¯¥ç«‹åˆ»ç»“æŸè¿è¡Œã€‚

```java
// ä¸­æ–­çº¿ç¨‹
public class Main {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new MyThread();
        t.start();
        Thread.sleep(1000);
        t.interrupt(); // ä¸­æ–­tçº¿ç¨‹
        t.join(); // ç­‰å¾…tçº¿ç¨‹ç»“æŸ
        System.out.println("end");
    }
}

class MyThread extends Thread {
    public void run() {
        Thread hello = new HelloThread();
        hello.start(); // å¯åŠ¨helloçº¿ç¨‹
        try {
            hello.join(); // ç­‰å¾…helloçº¿ç¨‹ç»“æŸ
        } catch (InterruptedException e) {
            System.out.println("interrupted!");
        }
        hello.interrupt();
    }
}

class HelloThread extends Thread {
    public void run() {
        int n = 0;
        while (!isInterrupted()) {
            n++;
            System.out.println(n + " hello!");
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                break;
            }
        }
    }
}

```

mainçº¿ç¨‹é€šè¿‡è°ƒç”¨t.interrupt()ä»è€Œé€šçŸ¥tçº¿ç¨‹ä¸­æ–­ï¼Œè€Œæ­¤æ—¶tçº¿ç¨‹æ­£ä½äºhello.join()çš„ç­‰å¾…ä¸­ï¼Œæ­¤æ–¹æ³•ä¼šç«‹åˆ»ç»“æŸç­‰å¾…å¹¶æŠ›å‡ºInterruptedExceptionã€‚ç”±äºæˆ‘ä»¬åœ¨tçº¿ç¨‹ä¸­æ•è·äº†InterruptedExceptionï¼Œå› æ­¤ï¼Œå°±å¯ä»¥å‡†å¤‡ç»“æŸè¯¥çº¿ç¨‹ã€‚åœ¨tçº¿ç¨‹ç»“æŸå‰ï¼Œå¯¹helloçº¿ç¨‹ä¹Ÿè¿›è¡Œäº†interrupt()è°ƒç”¨é€šçŸ¥å…¶ä¸­æ–­ã€‚å¦‚æœå»æ‰è¿™ä¸€è¡Œä»£ç ï¼Œå¯ä»¥å‘ç°helloçº¿ç¨‹ä»ç„¶ä¼šç»§ç»­è¿è¡Œï¼Œä¸”JVMä¸ä¼šé€€å‡ºã€‚

å¦ä¸€ä¸ªå¸¸ç”¨çš„ä¸­æ–­çº¿ç¨‹çš„æ–¹æ³•æ˜¯è®¾ç½®æ ‡å¿—ä½ã€‚æˆ‘ä»¬é€šå¸¸ä¼šç”¨ä¸€ä¸ªrunningæ ‡å¿—ä½æ¥æ ‡è¯†çº¿ç¨‹æ˜¯å¦åº”è¯¥ç»§ç»­è¿è¡Œï¼Œåœ¨å¤–éƒ¨çº¿ç¨‹ä¸­ï¼Œé€šè¿‡æŠŠHelloThread.runningç½®ä¸ºfalseï¼Œå°±å¯ä»¥è®©çº¿ç¨‹ç»“æŸï¼š

```java
// ä¸­æ–­çº¿ç¨‹
public class Main {
    public static void main(String[] args)  throws InterruptedException {
        HelloThread t = new HelloThread();
        t.start();
        Thread.sleep(1);
        t.running = false; // æ ‡å¿—ä½ç½®ä¸ºfalse
    }
}

class HelloThread extends Thread {
    public volatile boolean running = true;
    public void run() {
        int n = 0;
        while (running) {
            n ++;
            System.out.println(n + " hello!");
        }
        System.out.println("end!");
    }
}

```

æ³¨æ„åˆ°HelloThreadçš„æ ‡å¿—ä½boolean runningæ˜¯ä¸€ä¸ªçº¿ç¨‹é—´å…±äº«çš„å˜é‡ã€‚çº¿ç¨‹é—´å…±äº«å˜é‡éœ€è¦ä½¿ç”¨volatileå…³é”®å­—æ ‡è®°ï¼Œç¡®ä¿æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½è¯»å–åˆ°æ›´æ–°åçš„å˜é‡å€¼ã€‚

ä¸ºä»€ä¹ˆè¦å¯¹çº¿ç¨‹é—´å…±äº«çš„å˜é‡ç”¨å…³é”®å­—volatileå£°æ˜ï¼Ÿè¿™æ¶‰åŠåˆ°Javaçš„å†…å­˜æ¨¡å‹ã€‚åœ¨Javaè™šæ‹Ÿæœºä¸­ï¼Œå˜é‡çš„å€¼ä¿å­˜åœ¨ä¸»å†…å­˜ä¸­ï¼Œä½†æ˜¯ï¼Œå½“çº¿ç¨‹è®¿é—®å˜é‡æ—¶ï¼Œå®ƒä¼šå…ˆè·å–ä¸€ä¸ªå‰¯æœ¬ï¼Œå¹¶ä¿å­˜åœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­ã€‚å¦‚æœçº¿ç¨‹ä¿®æ”¹äº†å˜é‡çš„å€¼ï¼Œè™šæ‹Ÿæœºä¼šåœ¨æŸä¸ªæ—¶åˆ»æŠŠä¿®æ”¹åçš„å€¼å›å†™åˆ°ä¸»å†…å­˜ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ä¸ç¡®å®šçš„ï¼

â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”
           Main Memory
â”‚                               â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ var A â”‚â”‚ var B â”‚â”‚ var C â”‚  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚     â”‚ â–²               â”‚ â–²     â”‚
 â”€ â”€ â”€â”‚â”€â”‚â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”‚â”€â”‚â”€ â”€ â”€
      â”‚ â”‚               â”‚ â”‚
â”Œ â”€ â”€ â”¼ â”¼ â”€ â”€ â”   â”Œ â”€ â”€ â”¼ â”¼ â”€ â”€ â”
      â–¼ â”‚               â–¼ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚ var A â”‚         â”‚ var C â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   Thread 1          Thread 2
â”” â”€ â”€ â”€ â”€ â”€ â”€ â”˜   â”” â”€ â”€ â”€ â”€ â”€ â”€ â”˜

è¿™ä¼šå¯¼è‡´å¦‚æœä¸€ä¸ªçº¿ç¨‹æ›´æ–°äº†æŸä¸ªå˜é‡ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»å–çš„å€¼å¯èƒ½è¿˜æ˜¯æ›´æ–°å‰çš„ã€‚ä¾‹å¦‚ï¼Œä¸»å†…å­˜çš„å˜é‡a = trueï¼Œçº¿ç¨‹1æ‰§è¡Œa = falseæ—¶ï¼Œå®ƒåœ¨æ­¤åˆ»ä»…ä»…æ˜¯æŠŠå˜é‡açš„å‰¯æœ¬å˜æˆäº†falseï¼Œä¸»å†…å­˜çš„å˜é‡aè¿˜æ˜¯trueï¼Œåœ¨JVMæŠŠä¿®æ”¹åçš„aå›å†™åˆ°ä¸»å†…å­˜ä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹è¯»å–åˆ°çš„açš„å€¼ä»ç„¶æ˜¯trueï¼Œè¿™å°±é€ æˆäº†å¤šçº¿ç¨‹ä¹‹é—´å…±äº«çš„å˜é‡ä¸ä¸€è‡´ã€‚


å› æ­¤ï¼Œvolatileå…³é”®å­—çš„ç›®çš„æ˜¯å‘Šè¯‰è™šæ‹Ÿæœºï¼š

+ æ¯æ¬¡è®¿é—®å˜é‡æ—¶ï¼Œæ€»æ˜¯è·å–ä¸»å†…å­˜çš„æœ€æ–°å€¼ï¼›
+ æ¯æ¬¡ä¿®æ”¹å˜é‡åï¼Œç«‹åˆ»å›å†™åˆ°ä¸»å†…å­˜ã€‚

volatileå…³é”®å­—è§£å†³çš„æ˜¯å¯è§æ€§é—®é¢˜ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»çœ‹åˆ°ä¿®æ”¹åçš„å€¼ã€‚

å¦‚æœæˆ‘ä»¬å»æ‰volatileå…³é”®å­—ï¼Œè¿è¡Œä¸Šè¿°ç¨‹åºï¼Œå‘ç°æ•ˆæœå’Œå¸¦volatileå·®ä¸å¤šï¼Œè¿™æ˜¯å› ä¸ºåœ¨x86çš„æ¶æ„ä¸‹ï¼ŒJVMå›å†™ä¸»å†…å­˜çš„é€Ÿåº¦éå¸¸å¿«ï¼Œä½†æ˜¯ï¼Œæ¢æˆARMçš„æ¶æ„ï¼Œå°±ä¼šæœ‰æ˜¾è‘—çš„å»¶è¿Ÿã€‚

## 4. å®ˆæŠ¤çº¿ç¨‹

javaç¨‹åºå…¥å£å°±æ˜¯ç”±JVMå¯åŠ¨mainçº¿ç¨‹ï¼Œmainçº¿ç¨‹åˆå¯ä»¥å¯åŠ¨å…¶ä»–çº¿ç¨‹ã€‚å½“æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸæ—¶ï¼ŒJVMé€€å‡ºï¼Œè¿›ç¨‹ç»“æŸã€‚

å¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰é€€å‡ºï¼ŒJVMè¿›ç¨‹å°±ä¸ä¼šé€€å‡ºã€‚æ‰€ä»¥ï¼Œå¿…é¡»ä¿è¯æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½åŠæ—¶ç»“æŸã€‚

ä½†æ˜¯æœ‰ä¸€ç§çº¿ç¨‹çš„ç›®çš„å°±æ˜¯æ— é™å¾ªç¯ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªå®šæ—¶è§¦å‘ä»»åŠ¡çš„çº¿ç¨‹ï¼š

```java
class TimerThread extends Thread {
    @Override
    public void run() {
        while (true) {
            System.out.println(LocalTime.now());
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                break;
            }
        }
    }
}
```

å¦‚æœè¿™ä¸ªçº¿ç¨‹ä¸ç»“æŸï¼ŒJVMè¿›ç¨‹å°±æ— æ³•ç»“æŸã€‚é—®é¢˜æ˜¯ï¼Œç”±è°è´Ÿè´£ç»“æŸè¿™ä¸ªçº¿ç¨‹ï¼Ÿ

ç„¶è€Œè¿™ç±»çº¿ç¨‹ç»å¸¸æ²¡æœ‰è´Ÿè´£äººæ¥è´Ÿè´£ç»“æŸå®ƒä»¬ã€‚ä½†æ˜¯ï¼Œå½“å…¶ä»–çº¿ç¨‹ç»“æŸæ—¶ï¼ŒJVMè¿›ç¨‹åˆå¿…é¡»è¦ç»“æŸï¼Œæ€ä¹ˆåŠï¼Ÿ

ç­”æ¡ˆæ˜¯ä½¿ç”¨å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadï¼‰ã€‚

å®ˆæŠ¤çº¿ç¨‹æ˜¯æŒ‡ä¸ºå…¶ä»–çº¿ç¨‹æœåŠ¡çš„çº¿ç¨‹ã€‚åœ¨JVMä¸­ï¼Œæ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œæ— è®ºæœ‰æ²¡æœ‰å®ˆæŠ¤çº¿ç¨‹ï¼Œè™šæ‹Ÿæœºéƒ½ä¼šè‡ªåŠ¨é€€å‡ºã€‚

å› æ­¤ï¼ŒJVMé€€å‡ºæ—¶ï¼Œä¸å¿…å…³å¿ƒå®ˆæŠ¤çº¿ç¨‹æ˜¯å¦å·²ç»“æŸã€‚

å¦‚ä½•åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹å‘¢ï¼Ÿæ–¹æ³•å’Œæ™®é€šçº¿ç¨‹ä¸€æ ·ï¼Œåªæ˜¯åœ¨è°ƒç”¨start()æ–¹æ³•å‰ï¼Œè°ƒç”¨setDaemon(true)æŠŠè¯¥çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼š

```java
Thread t = new MyThread();
t.setDaemon(true);
t.start();

```

åœ¨å®ˆæŠ¤çº¿ç¨‹ä¸­ï¼Œç¼–å†™ä»£ç è¦æ³¨æ„ï¼šå®ˆæŠ¤çº¿ç¨‹ä¸èƒ½æŒæœ‰ä»»ä½•éœ€è¦å…³é—­çš„èµ„æºï¼Œä¾‹å¦‚æ‰“å¼€æ–‡ä»¶ç­‰ï¼Œå› ä¸ºè™šæ‹Ÿæœºé€€å‡ºæ—¶ï¼Œå®ˆæŠ¤çº¿ç¨‹æ²¡æœ‰ä»»ä½•æœºä¼šæ¥å…³é—­æ–‡ä»¶ï¼Œè¿™ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚

## 5. çº¿ç¨‹åŒæ­¥

Javaç¨‹åºä½¿ç”¨synchronizedå…³é”®å­—å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡ŒåŠ é”ï¼š

```java
synchronized(lock) {
    n = n + 1;
}
```

```java
// å¤šçº¿ç¨‹
public class Main {
    public static void main(String[] args) throws Exception {
        var add = new AddThread();
        var dec = new DecThread();
        add.start();
        dec.start();
        add.join();
        dec.join();
        System.out.println(Counter.count);
    }
}

class Counter {
    public static final Object lock = new Object();
    public static int count = 0;
}

class AddThread extends Thread {
    public void run() {
        for (int i=0; i<10000; i++) {
            synchronized(Counter.lock) {
                Counter.count += 1;
            }
        }
    }
}

class DecThread extends Thread {
    public void run() {
        for (int i=0; i<10000; i++) {
            synchronized(Counter.lock) {
                Counter.count -= 1;
            }
        }
    }
}

```

æ³¨æ„åˆ°ä»£ç ï¼š
```java
synchronized(Counter.lock) { // è·å–é”
    ...
} // é‡Šæ”¾é”
```

å®ƒè¡¨ç¤ºç”¨Counter.lockå®ä¾‹ä½œä¸ºé”ï¼Œä¸¤ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œå„è‡ªçš„synchronized(Counter.lock) { ... }ä»£ç å—æ—¶ï¼Œå¿…é¡»å…ˆè·å¾—é”ï¼Œæ‰èƒ½è¿›å…¥ä»£ç å—è¿›è¡Œã€‚æ‰§è¡Œç»“æŸåï¼Œåœ¨synchronizedè¯­å¥å—ç»“æŸä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¯¹Counter.countå˜é‡è¿›è¡Œè¯»å†™å°±ä¸å¯èƒ½åŒæ—¶è¿›è¡Œã€‚ä¸Šè¿°ä»£ç æ— è®ºè¿è¡Œå¤šå°‘æ¬¡ï¼Œæœ€ç»ˆç»“æœéƒ½æ˜¯0ã€‚

ä½¿ç”¨synchronizedè§£å†³äº†å¤šçº¿ç¨‹åŒæ­¥è®¿é—®å…±äº«å˜é‡çš„æ­£ç¡®æ€§é—®é¢˜ã€‚ä½†æ˜¯ï¼Œå®ƒçš„ç¼ºç‚¹æ˜¯å¸¦æ¥äº†æ€§èƒ½ä¸‹é™ã€‚å› ä¸ºsynchronizedä»£ç å—æ— æ³•å¹¶å‘æ‰§è¡Œã€‚æ­¤å¤–ï¼ŒåŠ é”å’Œè§£é”éœ€è¦æ¶ˆè€—ä¸€å®šçš„æ—¶é—´ï¼Œæ‰€ä»¥ï¼Œsynchronizedä¼šé™ä½ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚

æˆ‘ä»¬æ¥æ¦‚æ‹¬ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨synchronizedï¼š

+ æ‰¾å‡ºä¿®æ”¹å…±äº«å˜é‡çš„çº¿ç¨‹ä»£ç å—ï¼›
+ é€‰æ‹©ä¸€ä¸ªå…±äº«å®ä¾‹ä½œä¸ºé”ï¼›
+ ä½¿ç”¨synchronized(lockObject) { ... }ã€‚

åœ¨ä½¿ç”¨synchronizedçš„æ—¶å€™ï¼Œä¸å¿…æ‹…å¿ƒæŠ›å‡ºå¼‚å¸¸ã€‚å› ä¸ºæ— è®ºæ˜¯å¦æœ‰å¼‚å¸¸ï¼Œéƒ½ä¼šåœ¨synchronizedç»“æŸå¤„æ­£ç¡®é‡Šæ”¾é”ï¼š

```java
public void add(int m) {
    synchronized (obj) {
        if (m < 0) {
            throw new RuntimeException();
        }
        this.value += m;
    } // æ— è®ºæœ‰æ— å¼‚å¸¸ï¼Œéƒ½ä¼šåœ¨æ­¤é‡Šæ”¾é”
}

```

ä¸éœ€è¦synchronizedçš„æ“ä½œ

JVMè§„èŒƒå®šä¹‰äº†å‡ ç§åŸå­æ“ä½œï¼š

+ åŸºæœ¬ç±»å‹ï¼ˆlongå’Œdoubleé™¤å¤–ï¼‰èµ‹å€¼ï¼Œä¾‹å¦‚ï¼šint n = mï¼›
+ å¼•ç”¨ç±»å‹èµ‹å€¼ï¼Œä¾‹å¦‚ï¼šList<String> list = anotherListã€‚

longå’Œdoubleæ˜¯64ä½æ•°æ®ï¼ŒJVMæ²¡æœ‰æ˜ç¡®è§„å®š64ä½èµ‹å€¼æ“ä½œæ˜¯ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œä¸è¿‡åœ¨x64å¹³å°çš„JVMæ˜¯æŠŠlongå’Œdoubleçš„èµ‹å€¼ä½œä¸ºåŸå­æ“ä½œå®ç°çš„ã€‚

å•æ¡åŸå­æ“ä½œçš„è¯­å¥ä¸éœ€è¦åŒæ­¥ã€‚ä¾‹å¦‚ï¼š

```java
public void set(String s) {
    this.value = s;
}
```
å°±ä¸éœ€è¦åŒæ­¥ã€‚

å¯¹å¼•ç”¨ä¹Ÿæ˜¯ç±»ä¼¼ã€‚ä¾‹å¦‚ï¼š
```java
public void set(String s) {
    this.value = s;
}
```
ä¸Šè¿°èµ‹å€¼è¯­å¥å¹¶ä¸éœ€è¦åŒæ­¥ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ˜¯å¤šè¡Œèµ‹å€¼è¯­å¥ï¼Œå°±å¿…é¡»ä¿è¯æ˜¯åŒæ­¥æ“ä½œï¼Œä¾‹å¦‚ï¼š
```java
class Point {
    int x;
    int y;
    public void set(int x, int y) {
        synchronized(this) {
            this.x = x;
            this.y = y;
        }
    }
}

```

### 5.1 åŒæ­¥æ–¹æ³•

æˆ‘ä»¬çŸ¥é“Javaç¨‹åºä¾é synchronizedå¯¹çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œä½¿ç”¨synchronizedçš„æ—¶å€™ï¼Œé”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡éå¸¸é‡è¦ã€‚

è®©çº¿ç¨‹è‡ªå·±é€‰æ‹©é”å¯¹è±¡å¾€å¾€ä¼šä½¿å¾—ä»£ç é€»è¾‘æ··ä¹±ï¼Œä¹Ÿä¸åˆ©äºå°è£…ã€‚æ›´å¥½çš„æ–¹æ³•æ˜¯æŠŠsynchronizedé€»è¾‘å°è£…èµ·æ¥ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè®¡æ•°å™¨å¦‚ä¸‹ï¼š


```java
public class Counter {
    private int count = 0;

    public void add(int n) {
        synchronized(this) {
            count += n;
        }
    }

    public void dec(int n) {
        synchronized(this) {
            count -= n;
        }
    }

    public int get() {
        return count;
    }
}

```

è¿™æ ·ä¸€æ¥ï¼Œçº¿ç¨‹è°ƒç”¨add()ã€dec()æ–¹æ³•æ—¶ï¼Œå®ƒä¸å¿…å…³å¿ƒåŒæ­¥é€»è¾‘ï¼Œå› ä¸ºsynchronizedä»£ç å—åœ¨add()ã€dec()æ–¹æ³•å†…éƒ¨ã€‚å¹¶ä¸”ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œsynchronizedé”ä½çš„å¯¹è±¡æ˜¯thisï¼Œå³å½“å‰å®ä¾‹ï¼Œè¿™åˆä½¿å¾—åˆ›å»ºå¤šä¸ªCounterå®ä¾‹çš„æ—¶å€™ï¼Œå®ƒä»¬ä¹‹é—´äº’ä¸å½±å“ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œï¼š

```java
var c1 = Counter();
var c2 = Counter();

// å¯¹c1è¿›è¡Œæ“ä½œçš„çº¿ç¨‹:
new Thread(() -> {
    c1.add();
}).start();
new Thread(() -> {
    c1.dec();
}).start();

// å¯¹c2è¿›è¡Œæ“ä½œçš„çº¿ç¨‹:
new Thread(() -> {
    c2.add();
}).start();
new Thread(() -> {
    c2.dec();
}).start();

```

ç°åœ¨ï¼Œå¯¹äºCounterç±»ï¼Œå¤šçº¿ç¨‹å¯ä»¥æ­£ç¡®è°ƒç”¨ã€‚

å¦‚æœä¸€ä¸ªç±»è¢«è®¾è®¡ä¸ºå…è®¸å¤šçº¿ç¨‹æ­£ç¡®è®¿é—®ï¼Œæˆ‘ä»¬å°±è¯´è¿™ä¸ªç±»å°±æ˜¯â€œçº¿ç¨‹å®‰å…¨â€çš„ï¼ˆthread-safeï¼‰ï¼Œä¸Šé¢çš„Counterç±»å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚Javaæ ‡å‡†åº“çš„java.lang.StringBufferä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

è¿˜æœ‰ä¸€äº›ä¸å˜ç±»ï¼Œä¾‹å¦‚Stringï¼ŒIntegerï¼ŒLocalDateï¼Œå®ƒä»¬çš„æ‰€æœ‰æˆå‘˜å˜é‡éƒ½æ˜¯finalï¼Œå¤šçº¿ç¨‹åŒæ—¶è®¿é—®æ—¶åªèƒ½è¯»ä¸èƒ½å†™ï¼Œè¿™äº›ä¸å˜ç±»ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

æœ€åï¼Œç±»ä¼¼Mathè¿™äº›åªæä¾›é™æ€æ–¹æ³•ï¼Œæ²¡æœ‰æˆå‘˜å˜é‡çš„ç±»ï¼Œä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

é™¤äº†ä¸Šè¿°å‡ ç§å°‘æ•°æƒ…å†µï¼Œå¤§éƒ¨åˆ†ç±»ï¼Œä¾‹å¦‚ArrayListï¼Œéƒ½æ˜¯éçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¸­ä¿®æ”¹å®ƒä»¬ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½åªè¯»å–ï¼Œä¸å†™å…¥ï¼Œé‚£ä¹ˆArrayListæ˜¯å¯ä»¥å®‰å…¨åœ°åœ¨çº¿ç¨‹é—´å…±äº«çš„ã€‚


æˆ‘ä»¬å†è§‚å¯ŸCounterçš„ä»£ç ï¼š

```java
public class Counter {
    public void add(int n) {
        synchronized(this) {
            count += n;
        }
    }
    ...
}
```

å½“æˆ‘ä»¬é”ä½çš„æ˜¯thiså®ä¾‹æ—¶ï¼Œå®é™…ä¸Šå¯ä»¥ç”¨synchronizedä¿®é¥°è¿™ä¸ªæ–¹æ³•ã€‚ä¸‹é¢ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„ï¼š

```java
public void add(int n) {
    synchronized(this) { // é”ä½this
        count += n;
    } // è§£é”
}

```

```java
public synchronized void add(int n) { // é”ä½this
    count += n;
} // è§£é”

```

å› æ­¤ï¼Œç”¨synchronizedä¿®é¥°çš„æ–¹æ³•å°±æ˜¯åŒæ­¥æ–¹æ³•ï¼Œå®ƒè¡¨ç¤ºæ•´ä¸ªæ–¹æ³•éƒ½å¿…é¡»ç”¨thiså®ä¾‹åŠ é”ã€‚

æˆ‘ä»¬å†æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœå¯¹ä¸€ä¸ªé™æ€æ–¹æ³•æ·»åŠ synchronizedä¿®é¥°ç¬¦ï¼Œå®ƒé”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡ï¼Ÿ

```java
public synchronized static void test(int n) {
    ...
}
```

å¯¹äºstaticæ–¹æ³•ï¼Œæ˜¯æ²¡æœ‰thiså®ä¾‹çš„ï¼Œå› ä¸ºstaticæ–¹æ³•æ˜¯é’ˆå¯¹ç±»è€Œä¸æ˜¯å®ä¾‹ã€‚ä½†æ˜¯æˆ‘ä»¬æ³¨æ„åˆ°ä»»ä½•ä¸€ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªç”±JVMè‡ªåŠ¨åˆ›å»ºçš„Classå®ä¾‹ï¼Œå› æ­¤ï¼Œå¯¹staticæ–¹æ³•æ·»åŠ synchronizedï¼Œé”ä½çš„æ˜¯è¯¥ç±»çš„Classå®ä¾‹ã€‚ä¸Šè¿°synchronized staticæ–¹æ³•å®é™…ä¸Šç›¸å½“äºï¼š

```java
public class Counter {
    public static void test(int n) {
        synchronized(Counter.class) {
            ...
        }
    }
}
```

æˆ‘ä»¬å†è€ƒå¯ŸCounterçš„get()æ–¹æ³•ï¼š

```java
public class Counter {
    private int count;

    public int get() {
        return count;
    }
    ...
}
```

å®ƒæ²¡æœ‰åŒæ­¥ï¼Œå› ä¸ºè¯»ä¸€ä¸ªintå˜é‡ä¸éœ€è¦åŒæ­¥ã€‚

ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬æŠŠä»£ç ç¨å¾®æ”¹ä¸€ä¸‹ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªintçš„å¯¹è±¡ï¼š

```java
public class Counter {
    private int first;
    private int last;

    public Pair get() {
        Pair p = new Pair();
        p.first = first;
        p.last = last;
        return p;
    }
    ...
}
```

å°±å¿…é¡»è¦åŒæ­¥äº†ã€‚

### 5.2 æ­»é”

Javaçš„çº¿ç¨‹é”æ˜¯å¯é‡å…¥çš„é”ã€‚

ä»€ä¹ˆæ˜¯å¯é‡å…¥çš„é”ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹ä¾‹å­ï¼š

```java
public class Counter {
    private int count = 0;

    public synchronized void add(int n) {
        if (n < 0) {
            dec(-n);
        } else {
            count += n;
        }
    }

    public synchronized void dec(int n) {
        count += n;
    }
}

```

è§‚å¯Ÿsynchronizedä¿®é¥°çš„add()æ–¹æ³•ï¼Œä¸€æ—¦çº¿ç¨‹æ‰§è¡Œåˆ°add()æ–¹æ³•å†…éƒ¨ï¼Œè¯´æ˜å®ƒå·²ç»è·å–äº†å½“å‰å®ä¾‹çš„thisé”ã€‚å¦‚æœä¼ å…¥çš„n < 0ï¼Œå°†åœ¨add()æ–¹æ³•å†…éƒ¨è°ƒç”¨dec()æ–¹æ³•ã€‚ç”±äºdec()æ–¹æ³•ä¹Ÿéœ€è¦è·å–thisé”ï¼Œç°åœ¨é—®é¢˜æ¥äº†ï¼š

å¯¹åŒä¸€ä¸ªçº¿ç¨‹ï¼Œèƒ½å¦åœ¨è·å–åˆ°é”ä»¥åç»§ç»­è·å–åŒä¸€ä¸ªé”ï¼Ÿ

ç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚JVMå…è®¸åŒä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–åŒä¸€ä¸ªé”ï¼Œè¿™ç§èƒ½è¢«åŒä¸€ä¸ªçº¿ç¨‹åå¤è·å–çš„é”ï¼Œå°±å«åšå¯é‡å…¥é”ã€‚

ç”±äºJavaçš„çº¿ç¨‹é”æ˜¯å¯é‡å…¥é”ï¼Œæ‰€ä»¥ï¼Œè·å–é”çš„æ—¶å€™ï¼Œä¸ä½†è¦åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è·å–ï¼Œè¿˜è¦è®°å½•è¿™æ˜¯ç¬¬å‡ æ¬¡è·å–ã€‚æ¯è·å–ä¸€æ¬¡é”ï¼Œè®°å½•+1ï¼Œæ¯é€€å‡ºsynchronizedå—ï¼Œè®°å½•-1ï¼Œå‡åˆ°0çš„æ—¶å€™ï¼Œæ‰ä¼šçœŸæ­£é‡Šæ”¾é”ã€‚

æ­»é”

ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–ä¸€ä¸ªé”åï¼Œå†ç»§ç»­è·å–å¦ä¸€ä¸ªé”ã€‚ä¾‹å¦‚ï¼š

```java
public void add(int m) {
    synchronized(lockA) { // è·å¾—lockAçš„é”
        this.value += m;
        synchronized(lockB) { // è·å¾—lockBçš„é”
            this.another += m;
        } // é‡Šæ”¾lockBçš„é”
    } // é‡Šæ”¾lockAçš„é”
}

public void dec(int m) {
    synchronized(lockB) { // è·å¾—lockBçš„é”
        this.another -= m;
        synchronized(lockA) { // è·å¾—lockAçš„é”
            this.value -= m;
        } // é‡Šæ”¾lockAçš„é”
    } // é‡Šæ”¾lockBçš„é”
}

```

åœ¨è·å–å¤šä¸ªé”çš„æ—¶å€™ï¼Œä¸åŒçº¿ç¨‹è·å–å¤šä¸ªä¸åŒå¯¹è±¡çš„é”å¯èƒ½å¯¼è‡´æ­»é”ã€‚å¯¹äºä¸Šè¿°ä»£ç ï¼Œçº¿ç¨‹1å’Œçº¿ç¨‹2å¦‚æœåˆ†åˆ«æ‰§è¡Œadd()å’Œdec()æ–¹æ³•æ—¶ï¼š

çº¿ç¨‹1ï¼šè¿›å…¥add()ï¼Œè·å¾—lockAï¼›
çº¿ç¨‹2ï¼šè¿›å…¥dec()ï¼Œè·å¾—lockBã€‚
éšåï¼š

çº¿ç¨‹1ï¼šå‡†å¤‡è·å¾—lockBï¼Œå¤±è´¥ï¼Œç­‰å¾…ä¸­ï¼›
çº¿ç¨‹2ï¼šå‡†å¤‡è·å¾—lockAï¼Œå¤±è´¥ï¼Œç­‰å¾…ä¸­ã€‚
æ­¤æ—¶ï¼Œä¸¤ä¸ªçº¿ç¨‹å„è‡ªæŒæœ‰ä¸åŒçš„é”ï¼Œç„¶åå„è‡ªè¯•å›¾è·å–å¯¹æ–¹æ‰‹é‡Œçš„é”ï¼Œé€ æˆäº†åŒæ–¹æ— é™ç­‰å¾…ä¸‹å»ï¼Œè¿™å°±æ˜¯æ­»é”ã€‚

æ­»é”å‘ç”Ÿåï¼Œæ²¡æœ‰ä»»ä½•æœºåˆ¶èƒ½è§£é™¤æ­»é”ï¼Œåªèƒ½å¼ºåˆ¶ç»“æŸJVMè¿›ç¨‹ã€‚

å› æ­¤ï¼Œåœ¨ç¼–å†™å¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼Œè¦ç‰¹åˆ«æ³¨æ„é˜²æ­¢æ­»é”ã€‚å› ä¸ºæ­»é”ä¸€æ—¦å½¢æˆï¼Œå°±åªèƒ½å¼ºåˆ¶ç»“æŸè¿›ç¨‹ã€‚

é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•é¿å…æ­»é”å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šçº¿ç¨‹è·å–é”çš„é¡ºåºè¦ä¸€è‡´ã€‚å³ä¸¥æ ¼æŒ‰ç…§å…ˆè·å–lockAï¼Œå†è·å–lockBçš„é¡ºåºï¼Œæ”¹å†™dec()æ–¹æ³•å¦‚ä¸‹ï¼š

```java
public void dec(int m) {
    synchronized(lockA) { // è·å¾—lockAçš„é”
        this.value -= m;
        synchronized(lockB) { // è·å¾—lockBçš„é”
            this.another -= m;
        } // é‡Šæ”¾lockBçš„é”
    } // é‡Šæ”¾lockAçš„é”
}

```

### 5.3 ä½¿ç”¨waitå’Œnotify

åœ¨Javaç¨‹åºä¸­ï¼Œsynchronizedè§£å†³äº†å¤šçº¿ç¨‹ç«äº‰çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªä»»åŠ¡ç®¡ç†å™¨ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶å¾€é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ï¼Œå¯ä»¥ç”¨synchronizedåŠ é”ï¼š

```java
class TaskQueue {
    Queue<String> queue = new LinkedList<>();

    public synchronized void addTask(String s) {
        this.queue.add(s);
    }
}

```

ä½†æ˜¯synchronizedå¹¶æ²¡æœ‰è§£å†³å¤šçº¿ç¨‹åè°ƒçš„é—®é¢˜ã€‚

ä»ç„¶ä»¥ä¸Šé¢çš„TaskQueueä¸ºä¾‹ï¼Œæˆ‘ä»¬å†ç¼–å†™ä¸€ä¸ªgetTask()æ–¹æ³•å–å‡ºé˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼š

```java
class TaskQueue {
    Queue<String> queue = new LinkedList<>();

    public synchronized void addTask(String s) {
        this.queue.add(s);
    }

    public synchronized String getTask() {
        while (queue.isEmpty()) {
        }
        return queue.remove();
    }
}

```

ä¸Šè¿°ä»£ç çœ‹ä¸Šå»æ²¡æœ‰é—®é¢˜ï¼šgetTask()å†…éƒ¨å…ˆåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œå°±å¾ªç¯ç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹å¾€é˜Ÿåˆ—ä¸­æ”¾å…¥äº†ä¸€ä¸ªä»»åŠ¡ï¼Œwhile()å¾ªç¯é€€å‡ºï¼Œå°±å¯ä»¥è¿”å›é˜Ÿåˆ—çš„å…ƒç´ äº†ã€‚

ä½†å®é™…ä¸Šwhile()å¾ªç¯æ°¸è¿œä¸ä¼šé€€å‡ºã€‚å› ä¸ºçº¿ç¨‹åœ¨æ‰§è¡Œwhile()å¾ªç¯æ—¶ï¼Œå·²ç»åœ¨getTask()å…¥å£è·å–äº†thisé”ï¼Œå…¶ä»–çº¿ç¨‹æ ¹æœ¬æ— æ³•è°ƒç”¨addTask()ï¼Œå› ä¸ºaddTask()æ‰§è¡Œæ¡ä»¶ä¹Ÿæ˜¯è·å–thisé”ã€‚

å› æ­¤ï¼Œæ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œçº¿ç¨‹ä¼šåœ¨getTask()ä¸­å› ä¸ºæ­»å¾ªç¯è€Œ100%å ç”¨CPUèµ„æºã€‚

å¦‚æœæ·±å…¥æ€è€ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬æƒ³è¦çš„æ‰§è¡Œæ•ˆæœæ˜¯ï¼š

+ çº¿ç¨‹1å¯ä»¥è°ƒç”¨addTask()ä¸æ–­å¾€é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ï¼›
+ çº¿ç¨‹2å¯ä»¥è°ƒç”¨getTask()ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™getTask()åº”è¯¥ç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­è‡³å°‘æœ‰ä¸€ä¸ªä»»åŠ¡æ—¶å†è¿”å›ã€‚

å› æ­¤ï¼Œå¤šçº¿ç¨‹åè°ƒè¿è¡Œçš„åŸåˆ™å°±æ˜¯ï¼šå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼›å½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹è¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œä»»åŠ¡ã€‚

å¯¹äºä¸Šè¿°TaskQueueï¼Œæˆ‘ä»¬å…ˆæ”¹é€ getTask()æ–¹æ³•ï¼Œåœ¨æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼š

```java
public synchronized String getTask() {
    while (queue.isEmpty()) {
        this.wait();
    }
    return queue.remove();
}
```

å½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°getTask()æ–¹æ³•å†…éƒ¨çš„whileå¾ªç¯æ—¶ï¼Œå®ƒå¿…å®šå·²ç»è·å–åˆ°äº†thisé”ï¼Œæ­¤æ—¶ï¼Œçº¿ç¨‹æ‰§è¡Œwhileæ¡ä»¶åˆ¤æ–­ï¼Œå¦‚æœæ¡ä»¶æˆç«‹ï¼ˆé˜Ÿåˆ—ä¸ºç©ºï¼‰ï¼Œçº¿ç¨‹å°†æ‰§è¡Œthis.wait()ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚

**è¿™é‡Œçš„å…³é”®æ˜¯ï¼šwait()æ–¹æ³•å¿…é¡»åœ¨å½“å‰è·å–çš„é”å¯¹è±¡ä¸Šè°ƒç”¨ï¼Œè¿™é‡Œè·å–çš„æ˜¯thisé”ï¼Œå› æ­¤è°ƒç”¨this.wait()ã€‚**

è°ƒç”¨wait()æ–¹æ³•åï¼Œçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œwait()æ–¹æ³•ä¸ä¼šè¿”å›ï¼Œç›´åˆ°å°†æ¥æŸä¸ªæ—¶åˆ»ï¼Œçº¿ç¨‹ä»ç­‰å¾…çŠ¶æ€è¢«å…¶ä»–çº¿ç¨‹å”¤é†’åï¼Œwait()æ–¹æ³•æ‰ä¼šè¿”å›ï¼Œç„¶åï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡è¯­å¥ã€‚

æœ‰äº›ä»”ç»†çš„ç«¥é‹ä¼šæŒ‡å‡ºï¼šå³ä½¿çº¿ç¨‹åœ¨getTask()å†…éƒ¨ç­‰å¾…ï¼Œå…¶ä»–çº¿ç¨‹å¦‚æœæ‹¿ä¸åˆ°thisé”ï¼Œç…§æ ·æ— æ³•æ‰§è¡ŒaddTask()ï¼Œè‚¿ä¹ˆåŠï¼Ÿ

è¿™ä¸ªé—®é¢˜çš„å…³é”®å°±åœ¨äºwait()æ–¹æ³•çš„æ‰§è¡Œæœºåˆ¶éå¸¸å¤æ‚ã€‚é¦–å…ˆï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„Javaæ–¹æ³•ï¼Œè€Œæ˜¯å®šä¹‰åœ¨Objectç±»çš„ä¸€ä¸ªnativeæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç”±JVMçš„Cä»£ç å®ç°çš„ã€‚å…¶æ¬¡ï¼Œå¿…é¡»åœ¨synchronizedå—ä¸­æ‰èƒ½è°ƒç”¨wait()æ–¹æ³•ï¼Œå› ä¸ºwait()æ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šé‡Šæ”¾çº¿ç¨‹è·å¾—çš„é”ï¼Œwait()æ–¹æ³•è¿”å›æ—¶ï¼Œçº¿ç¨‹åˆä¼šé‡æ–°è¯•å›¾è·å¾—é”ã€‚

å› æ­¤ï¼Œåªèƒ½åœ¨é”å¯¹è±¡ä¸Šè°ƒç”¨wait()æ–¹æ³•ã€‚å› ä¸ºåœ¨getTask()ä¸­ï¼Œæˆ‘ä»¬è·å¾—äº†thisé”ï¼Œå› æ­¤ï¼Œåªèƒ½åœ¨thiså¯¹è±¡ä¸Šè°ƒç”¨wait()æ–¹æ³•ï¼š

```java
public synchronized String getTask() {
    while (queue.isEmpty()) {
        // é‡Šæ”¾thisé”:
        this.wait();
        // é‡æ–°è·å–thisé”
    }
    return queue.remove();
}
```

å½“ä¸€ä¸ªçº¿ç¨‹åœ¨this.wait()ç­‰å¾…æ—¶ï¼Œå®ƒå°±ä¼šé‡Šæ”¾thisé”ï¼Œä»è€Œä½¿å¾—å…¶ä»–çº¿ç¨‹èƒ½å¤Ÿåœ¨addTask()æ–¹æ³•è·å¾—thisé”ã€‚

ç°åœ¨æˆ‘ä»¬é¢ä¸´ç¬¬äºŒä¸ªé—®é¢˜ï¼šå¦‚ä½•è®©ç­‰å¾…çš„çº¿ç¨‹è¢«é‡æ–°å”¤é†’ï¼Œç„¶åä»wait()æ–¹æ³•è¿”å›ï¼Ÿç­”æ¡ˆæ˜¯åœ¨ç›¸åŒçš„é”å¯¹è±¡ä¸Šè°ƒç”¨notify()æ–¹æ³•ã€‚æˆ‘ä»¬ä¿®æ”¹addTask()å¦‚ä¸‹ï¼š

```java
public synchronized void addTask(String s) {
    this.queue.add(s);
    this.notify(); // å”¤é†’åœ¨thisé”ç­‰å¾…çš„çº¿ç¨‹
}
```

æ³¨æ„åˆ°åœ¨å¾€é˜Ÿåˆ—ä¸­æ·»åŠ äº†ä»»åŠ¡åï¼Œçº¿ç¨‹ç«‹åˆ»å¯¹thisé”å¯¹è±¡è°ƒç”¨notify()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå”¤é†’ä¸€ä¸ªæ­£åœ¨thisé”ç­‰å¾…çš„çº¿ç¨‹ï¼ˆå°±æ˜¯åœ¨getTask()ä¸­ä½äºthis.wait()çš„çº¿ç¨‹ï¼‰ï¼Œä»è€Œä½¿å¾—ç­‰å¾…çº¿ç¨‹ä»this.wait()æ–¹æ³•è¿”å›ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ï¼š

```java
import java.util.*;

public class Main {
    public static void main(String[] args) throws InterruptedException {
        var q = new TaskQueue();
        var ts = new ArrayList<Thread>();
        for (int i=0; i<5; i++) {
            var t = new Thread() {
                public void run() {
                    // æ‰§è¡Œtask:
                    while (true) {
                        try {
                            String s = q.getTask();
                            System.out.println("execute task: " + s);
                        } catch (InterruptedException e) {
                            return;
                        }
                    }
                }
            };
            t.start();
            ts.add(t);
        }
        var add = new Thread(() -> {
            for (int i=0; i<10; i++) {
                // æ”¾å…¥task:
                String s = "t-" + Math.random();
                System.out.println("add task: " + s);
                q.addTask(s);
                try { Thread.sleep(100); } catch(InterruptedException e) {}
            }
        });
        add.start();
        add.join();
        Thread.sleep(100);
        for (var t : ts) {
            t.interrupt();
        }
    }
}

class TaskQueue {
    Queue<String> queue = new LinkedList<>();

    public synchronized void addTask(String s) {
        this.queue.add(s);
        this.notifyAll();
    }

    public synchronized String getTask() throws InterruptedException {
        while (queue.isEmpty()) {
            this.wait();
        }
        return queue.remove();
    }
}

```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨addTask()æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨äº†this.notifyAll()è€Œä¸æ˜¯this.notify()ï¼Œä½¿ç”¨notifyAll()å°†å”¤é†’æ‰€æœ‰å½“å‰æ­£åœ¨thisé”ç­‰å¾…çš„çº¿ç¨‹ï¼Œè€Œnotify()åªä¼šå”¤é†’å…¶ä¸­ä¸€ä¸ªï¼ˆå…·ä½“å“ªä¸ªä¾èµ–æ“ä½œç³»ç»Ÿï¼Œæœ‰ä¸€å®šçš„éšæœºæ€§ï¼‰ã€‚è¿™æ˜¯å› ä¸ºå¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹æ­£åœ¨getTask()æ–¹æ³•å†…éƒ¨çš„wait()ä¸­ç­‰å¾…ï¼Œä½¿ç”¨notifyAll()å°†ä¸€æ¬¡æ€§å…¨éƒ¨å”¤é†’ã€‚é€šå¸¸æ¥è¯´ï¼ŒnotifyAll()æ›´å®‰å…¨ã€‚æœ‰äº›æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬çš„ä»£ç é€»è¾‘è€ƒè™‘ä¸å‘¨ï¼Œç”¨notify()ä¼šå¯¼è‡´åªå”¤é†’äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œå…¶ä»–çº¿ç¨‹å¯èƒ½æ°¸è¿œç­‰å¾…ä¸‹å»é†’ä¸è¿‡æ¥äº†ã€‚

ä½†æ˜¯ï¼Œæ³¨æ„åˆ°wait()æ–¹æ³•è¿”å›æ—¶éœ€è¦é‡æ–°è·å¾—thisé”ã€‚å‡è®¾å½“å‰æœ‰3ä¸ªçº¿ç¨‹è¢«å”¤é†’ï¼Œå”¤é†’åï¼Œé¦–å…ˆè¦ç­‰å¾…æ‰§è¡ŒaddTask()çš„çº¿ç¨‹ç»“æŸæ­¤æ–¹æ³•åï¼Œæ‰èƒ½é‡Šæ”¾thisé”ï¼Œéšåï¼Œè¿™3ä¸ªçº¿ç¨‹ä¸­åªèƒ½æœ‰ä¸€ä¸ªè·å–åˆ°thisé”ï¼Œå‰©ä¸‹ä¸¤ä¸ªå°†ç»§ç»­ç­‰å¾…ã€‚

å†æ³¨æ„åˆ°æˆ‘ä»¬åœ¨while()å¾ªç¯ä¸­è°ƒç”¨wait()ï¼Œè€Œä¸æ˜¯ifè¯­å¥ï¼š

```java
public synchronized String getTask() throws InterruptedException {
    if (queue.isEmpty()) {
        this.wait();
    }
    return queue.remove();
}
```

è¿™ç§å†™æ³•å®é™…ä¸Šæ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºçº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œéœ€è¦å†æ¬¡è·å–thisé”ã€‚å¤šä¸ªçº¿ç¨‹è¢«å”¤é†’åï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–thisé”ï¼Œæ­¤åˆ»ï¼Œè¯¥çº¿ç¨‹æ‰§è¡Œqueue.remove()å¯ä»¥è·å–åˆ°é˜Ÿåˆ—çš„å…ƒç´ ï¼Œç„¶è€Œï¼Œå‰©ä¸‹çš„çº¿ç¨‹å¦‚æœè·å–thisé”åæ‰§è¡Œqueue.remove()ï¼Œæ­¤åˆ»é˜Ÿåˆ—å¯èƒ½å·²ç»æ²¡æœ‰ä»»ä½•å…ƒç´ äº†ï¼Œæ‰€ä»¥ï¼Œè¦å§‹ç»ˆåœ¨whileå¾ªç¯ä¸­wait()ï¼Œå¹¶ä¸”æ¯æ¬¡è¢«å”¤é†’åæ‹¿åˆ°thisé”å°±å¿…é¡»å†æ¬¡åˆ¤æ–­ï¼š


```java
while (queue.isEmpty()) {
    this.wait();
}
```

### 5.4 ä½¿ç”¨ReentrantLock

æˆ‘ä»¬çŸ¥é“Javaè¯­è¨€ç›´æ¥æä¾›äº†synchronizedå…³é”®å­—ç”¨äºåŠ é”ï¼Œä½†è¿™ç§é”ä¸€æ˜¯å¾ˆé‡ï¼ŒäºŒæ˜¯è·å–æ—¶å¿…é¡»ä¸€ç›´ç­‰å¾…ï¼Œæ²¡æœ‰é¢å¤–çš„å°è¯•æœºåˆ¶ã€‚

java.util.concurrent.locksåŒ…æä¾›çš„ReentrantLockç”¨äº**æ›¿ä»£**synchronizedåŠ é”ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¼ ç»Ÿçš„synchronizedä»£ç ï¼š

```java
public class Counter {
    private int count;

    public void add(int n) {
        synchronized(this) {
            count += n;
        }
    }
}
```

å¦‚æœç”¨ReentrantLockæ›¿ä»£ï¼Œå¯ä»¥æŠŠä»£ç æ”¹é€ ä¸ºï¼š

```java
public class Counter {
    private final Lock lock = new ReentrantLock();
    private int count;

    public void add(int n) {
        lock.lock();
        try {
            count += n;
        } finally {
            lock.unlock();
        }
    }
}

```

å› ä¸ºsynchronizedæ˜¯Javaè¯­è¨€å±‚é¢æä¾›çš„è¯­æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘å¼‚å¸¸ï¼Œè€ŒReentrantLockæ˜¯Javaä»£ç å®ç°çš„é”ï¼Œæˆ‘ä»¬å°±å¿…é¡»å…ˆè·å–é”ï¼Œç„¶ååœ¨finallyä¸­æ­£ç¡®é‡Šæ”¾é”ã€‚

é¡¾åæ€ä¹‰ï¼ŒReentrantLock æ˜¯å¯é‡å…¥é”ï¼Œå®ƒå’Œsynchronizedä¸€æ ·ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€ä¸ªé”ã€‚

å’Œsynchronizedä¸åŒçš„æ˜¯ï¼ŒReentrantLockå¯ä»¥å°è¯•è·å–é”ï¼š

```java
if (lock.tryLock(1, TimeUnit.SECONDS)) {
    try {
        ...
    } finally {
        lock.unlock();
    }
}

```

ä¸Šè¿°ä»£ç åœ¨å°è¯•è·å–é”çš„æ—¶å€™ï¼Œæœ€å¤šç­‰å¾…1ç§’ã€‚å¦‚æœ1ç§’åä»æœªè·å–åˆ°é”ï¼ŒtryLock()è¿”å›falseï¼Œç¨‹åºå°±å¯ä»¥åšä¸€äº›é¢å¤–å¤„ç†ï¼Œè€Œä¸æ˜¯æ— é™ç­‰å¾…ä¸‹å»ã€‚

æ‰€ä»¥ï¼Œä½¿ç”¨ReentrantLockæ¯”ç›´æ¥ä½¿ç”¨synchronizedæ›´å®‰å…¨ï¼Œçº¿ç¨‹åœ¨tryLock()å¤±è´¥çš„æ—¶å€™ä¸ä¼šå¯¼è‡´æ­»é”ã€‚

ç‰¹æ€§ | synchronized | ReentrantLock
ç±»å‹ | å…³é”®å­—ï¼ˆè¯­è¨€çº§ï¼‰ | ç±»ï¼ˆAPI æä¾›ï¼‰
å¯é‡å…¥æ€§ | âœ… æ”¯æŒ | âœ… æ”¯æŒ
è‡ªåŠ¨é‡Šæ”¾é” | âœ… ç¦»å¼€ä»£ç å—è‡ªåŠ¨é‡Šæ”¾ | âŒ éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ lock.unlock()
çµæ´»æ€§ | â›” æ¯”è¾ƒæœ‰é™ | âœ… æ›´çµæ´»
å…¬å¹³é” | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆå¯é€‰å…¬å¹³æ€§ï¼‰
å¯ä¸­æ–­ | âŒ ä¸æ”¯æŒçº¿ç¨‹ä¸­æ–­ç­‰å¾…é” | âœ… æ”¯æŒ
å°è¯•åŠ é” | âŒ ä¸æ”¯æŒ | âœ… tryLock() æ”¯æŒéé˜»å¡å°è¯•åŠ é”
æ¡ä»¶å˜é‡ | âŒ å†…å»ºå•ä¸ªæ¡ä»¶ | âœ… å¯å¤šä¸ª Condition å¯¹è±¡


ä¸­æ–­æ§åˆ¶ï¼š lock.lockInterruptibly() å¯ä¸­æ–­åœ°åŠ é”ã€‚
å°è¯•åŠ é”ï¼š tryLock() æ”¯æŒéé˜»å¡è·å–é”ã€‚
å…¬å¹³é”ï¼š æ„é€ æ—¶ä¼ å…¥ trueï¼šnew ReentrantLock(true)ã€‚
æ¡ä»¶å˜é‡ï¼š å¯åˆ›å»ºå¤šä¸ª Conditionï¼Œå®ç°æ›´å¤æ‚çš„åŒæ­¥ï¼ˆæ¯”å¦‚å¤šä¸ªçº¿ç¨‹åä½œç”Ÿäº§æ¶ˆè´¹ï¼‰ã€‚


### 5.5 ä½¿ç”¨Condition

ä½¿ç”¨ReentrantLockæ¯”ç›´æ¥ä½¿ç”¨synchronizedæ›´å®‰å…¨ï¼Œå¯ä»¥æ›¿ä»£synchronizedè¿›è¡Œçº¿ç¨‹åŒæ­¥ã€‚

ä½†æ˜¯ï¼Œsynchronizedå¯ä»¥é…åˆwaitå’Œnotifyå®ç°çº¿ç¨‹åœ¨æ¡ä»¶ä¸æ»¡è¶³æ—¶ç­‰å¾…ï¼Œæ¡ä»¶æ»¡è¶³æ—¶å”¤é†’ï¼Œç”¨ReentrantLockæˆ‘ä»¬æ€ä¹ˆç¼–å†™waitå’Œnotifyçš„åŠŸèƒ½å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ä½¿ç”¨Conditionå¯¹è±¡æ¥å®ç°waitå’Œnotifyçš„åŠŸèƒ½ã€‚

æˆ‘ä»¬ä»ç„¶ä»¥TaskQueueä¸ºä¾‹ï¼ŒæŠŠå‰é¢ç”¨synchronizedå®ç°çš„åŠŸèƒ½é€šè¿‡ReentrantLockå’ŒConditionæ¥å®ç°ï¼š

```java
class TaskQueue {
    private final Lock lock = new ReentrantLock();
    private final Condition condition = lock.newCondition();
    private Queue<String> queue = new LinkedList<>();

    public void addTask(String s) {
        lock.lock();
        try {
            queue.add(s);
            condition.signalAll();
        } finally {
            lock.unlock();
        }
    }

    public String getTask() {
        lock.lock();
        try {
            while (queue.isEmpty()) {
                condition.await();
            }
            return queue.remove();
        } finally {
            lock.unlock();
        }
    }
}

```

å¯è§ï¼Œä½¿ç”¨Conditionæ—¶ï¼Œå¼•ç”¨çš„Conditionå¯¹è±¡å¿…é¡»ä»Lockå®ä¾‹çš„newCondition()è¿”å›ï¼Œè¿™æ ·æ‰èƒ½è·å¾—ä¸€ä¸ªç»‘å®šäº†Lockå®ä¾‹çš„Conditionå®ä¾‹ã€‚

Conditionæä¾›çš„await()ã€signal()ã€signalAll()åŸç†å’Œsynchronizedé”å¯¹è±¡çš„wait()ã€notify()ã€notifyAll()æ˜¯ä¸€è‡´çš„ï¼Œå¹¶ä¸”å…¶è¡Œä¸ºä¹Ÿæ˜¯ä¸€æ ·çš„ï¼š

+ await()ä¼šé‡Šæ”¾å½“å‰é”ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼›
+ signal()ä¼šå”¤é†’æŸä¸ªç­‰å¾…çº¿ç¨‹ï¼›
+ signalAll()ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼›
+ å”¤é†’çº¿ç¨‹ä»await()è¿”å›åéœ€è¦é‡æ–°è·å¾—é”ã€‚

æ­¤å¤–ï¼Œå’ŒtryLock()ç±»ä¼¼ï¼Œawait()å¯ä»¥åœ¨ç­‰å¾…æŒ‡å®šæ—¶é—´åï¼Œå¦‚æœè¿˜æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹é€šè¿‡signal()æˆ–signalAll()å”¤é†’ï¼Œå¯ä»¥è‡ªå·±é†’æ¥ï¼š

```java
if (condition.await(1, TimeUnit.SECOND)) {
    // è¢«å…¶ä»–çº¿ç¨‹å”¤é†’
} else {
    // æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹å”¤é†’
}
```

å¯è§ï¼Œä½¿ç”¨Conditioné…åˆLockï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æ›´çµæ´»çš„çº¿ç¨‹åŒæ­¥ã€‚

å°ç»“
Conditionå¯ä»¥æ›¿ä»£waitå’Œnotifyï¼›

Conditionå¯¹è±¡å¿…é¡»ä»Lockå¯¹è±¡è·å–ã€‚

### 5.6 ä½¿ç”¨ReadWriteLock

å‰é¢è®²åˆ°çš„ReentrantLockä¿è¯äº†åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œä¸´ç•ŒåŒºä»£ç ï¼š

```java
public class Counter {
    private final Lock lock = new ReentrantLock();
    private int[] counts = new int[10];

    public void inc(int index) {
        lock.lock();
        try {
            counts[index] += 1;
        } finally {
            lock.unlock();
        }
    }

    public int[] get() {
        lock.lock();
        try {
            return Arrays.copyOf(counts, counts.length);
        } finally {
            lock.unlock();
        }
    }
}

```

ä½†æ˜¯æœ‰äº›æ—¶å€™ï¼Œè¿™ç§ä¿æŠ¤æœ‰ç‚¹è¿‡å¤´ã€‚å› ä¸ºæˆ‘ä»¬å‘ç°ï¼Œä»»ä½•æ—¶åˆ»ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨inc()æ–¹æ³•æ˜¯å¿…é¡»è·å–é”ï¼Œä½†æ˜¯ï¼Œget()æ–¹æ³•åªè¯»å–æ•°æ®ï¼Œä¸ä¿®æ”¹æ•°æ®ï¼Œå®ƒå®é™…ä¸Šå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ã€‚

å®é™…ä¸Šæˆ‘ä»¬æƒ³è¦çš„æ˜¯ï¼šå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ï¼Œä½†åªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å†™ï¼Œå…¶ä»–çº¿ç¨‹å°±å¿…é¡»ç­‰å¾…ï¼š

ä½¿ç”¨ReadWriteLockå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒä¿è¯ï¼š

+ åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å…¥ï¼ˆå…¶ä»–çº¿ç¨‹æ—¢ä¸èƒ½å†™å…¥ä¹Ÿä¸èƒ½è¯»å–ï¼‰ï¼›
+ æ²¡æœ‰å†™å…¥æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹å…è®¸åŒæ—¶è¯»ï¼ˆæé«˜æ€§èƒ½ï¼‰ã€‚

ç”¨ReadWriteLockå®ç°è¿™ä¸ªåŠŸèƒ½ååˆ†å®¹æ˜“ã€‚æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªReadWriteLockå®ä¾‹ï¼Œç„¶ååˆ†åˆ«è·å–è¯»é”å’Œå†™é”ï¼š

```java
public class Counter {
    private final ReadWriteLock rwlock = new ReentrantReadWriteLock();
    // æ³¨æ„: ä¸€å¯¹è¯»é”å’Œå†™é”å¿…é¡»ä»åŒä¸€ä¸ªrwlockè·å–:
    private final Lock rlock = rwlock.readLock();
    private final Lock wlock = rwlock.writeLock();
    private int[] counts = new int[10];

    public void inc(int index) {
        wlock.lock(); // åŠ å†™é”
        try {
            counts[index] += 1;
        } finally {
            wlock.unlock(); // é‡Šæ”¾å†™é”
        }
    }

    public int[] get() {
        rlock.lock(); // åŠ è¯»é”
        try {
            return Arrays.copyOf(counts, counts.length);
        } finally {
            rlock.unlock(); // é‡Šæ”¾è¯»é”
        }
    }
}
```

æŠŠè¯»å†™æ“ä½œåˆ†åˆ«ç”¨è¯»é”å’Œå†™é”æ¥åŠ é”ï¼Œåœ¨è¯»å–æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è·å¾—è¯»é”ï¼Œè¿™æ ·å°±å¤§å¤§æé«˜äº†å¹¶å‘è¯»çš„æ‰§è¡Œæ•ˆç‡ã€‚

ä½¿ç”¨ReadWriteLockæ—¶ï¼Œé€‚ç”¨æ¡ä»¶æ˜¯åŒä¸€ä¸ªæ•°æ®ï¼Œæœ‰å¤§é‡çº¿ç¨‹è¯»å–ï¼Œä½†ä»…æœ‰å°‘æ•°çº¿ç¨‹ä¿®æ”¹ã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ªè®ºå›çš„å¸–å­ï¼Œå›å¤å¯ä»¥çœ‹åšå†™å…¥æ“ä½œï¼Œå®ƒæ˜¯ä¸é¢‘ç¹çš„ï¼Œä½†æ˜¯ï¼Œæµè§ˆå¯ä»¥çœ‹åšè¯»å–æ“ä½œï¼Œæ˜¯éå¸¸é¢‘ç¹çš„ï¼Œè¿™ç§æƒ…å†µå°±å¯ä»¥ä½¿ç”¨ReadWriteLockã€‚


### 5.7 ä½¿ç”¨StampedLock

å‰é¢ä»‹ç»çš„ReadWriteLockå¯ä»¥è§£å†³å¤šçº¿ç¨‹åŒæ—¶è¯»ï¼Œä½†åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å†™çš„é—®é¢˜ã€‚

å¦‚æœæˆ‘ä»¬æ·±å…¥åˆ†æReadWriteLockï¼Œä¼šå‘ç°å®ƒæœ‰ä¸ªæ½œåœ¨çš„é—®é¢˜ï¼šå¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨è¯»ï¼Œå†™çº¿ç¨‹éœ€è¦ç­‰å¾…è¯»çº¿ç¨‹é‡Šæ”¾é”åæ‰èƒ½è·å–å†™é”ï¼Œå³è¯»çš„è¿‡ç¨‹ä¸­ä¸å…è®¸å†™ï¼Œè¿™æ˜¯ä¸€ç§æ‚²è§‚çš„è¯»é”ã€‚

è¦è¿›ä¸€æ­¥æå‡å¹¶å‘æ‰§è¡Œæ•ˆç‡ï¼ŒJava 8å¼•å…¥äº†æ–°çš„è¯»å†™é”ï¼šStampedLockã€‚

StampedLockå’ŒReadWriteLockç›¸æ¯”ï¼Œ**æ”¹è¿›ä¹‹å¤„åœ¨äºï¼šè¯»çš„è¿‡ç¨‹ä¸­ä¹Ÿå…è®¸è·å–å†™é”åå†™å…¥ï¼**è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬è¯»çš„æ•°æ®å°±å¯èƒ½ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ï¼Œéœ€è¦ä¸€ç‚¹é¢å¤–çš„ä»£ç æ¥åˆ¤æ–­è¯»çš„è¿‡ç¨‹ä¸­æ˜¯å¦æœ‰å†™å…¥ï¼Œè¿™ç§è¯»é”æ˜¯ä¸€ç§**ä¹è§‚é”**ã€‚

ä¹è§‚é”çš„æ„æ€å°±æ˜¯ä¹è§‚åœ°ä¼°è®¡è¯»çš„è¿‡ç¨‹ä¸­å¤§æ¦‚ç‡ä¸ä¼šæœ‰å†™å…¥ï¼Œå› æ­¤è¢«ç§°ä¸ºä¹è§‚é”ã€‚åè¿‡æ¥ï¼Œæ‚²è§‚é”åˆ™æ˜¯è¯»çš„è¿‡ç¨‹ä¸­æ‹’ç»æœ‰å†™å…¥ï¼Œä¹Ÿå°±æ˜¯å†™å…¥å¿…é¡»ç­‰å¾…ã€‚æ˜¾ç„¶ä¹è§‚é”çš„å¹¶å‘æ•ˆç‡æ›´é«˜ï¼Œä½†ä¸€æ—¦æœ‰å°æ¦‚ç‡çš„å†™å…¥å¯¼è‡´è¯»å–çš„æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦èƒ½æ£€æµ‹å‡ºæ¥ï¼Œå†è¯»ä¸€éå°±è¡Œã€‚

```java
public class Point {
    private final StampedLock stampedLock = new StampedLock();

    private double x;
    private double y;

    public void move(double deltaX, double deltaY) {
        long stamp = stampedLock.writeLock(); // è·å–å†™é”
        try {
            x += deltaX;
            y += deltaY;
        } finally {
            stampedLock.unlockWrite(stamp); // é‡Šæ”¾å†™é”
        }
    }

    public double distanceFromOrigin() {
        long stamp = stampedLock.tryOptimisticRead(); // è·å¾—ä¸€ä¸ªä¹è§‚è¯»é”
        // æ³¨æ„ä¸‹é¢ä¸¤è¡Œä»£ç ä¸æ˜¯åŸå­æ“ä½œ
        // å‡è®¾x,y = (100,200)
        double currentX = x;
        // æ­¤å¤„å·²è¯»å–åˆ°x=100ï¼Œä½†x,yå¯èƒ½è¢«å†™çº¿ç¨‹ä¿®æ”¹ä¸º(300,400)
        double currentY = y;
        // æ­¤å¤„å·²è¯»å–åˆ°yï¼Œå¦‚æœæ²¡æœ‰å†™å…¥ï¼Œè¯»å–æ˜¯æ­£ç¡®çš„(100,200)
        // å¦‚æœæœ‰å†™å…¥ï¼Œè¯»å–æ˜¯é”™è¯¯çš„(100,400)
        if (!stampedLock.validate(stamp)) { // æ£€æŸ¥ä¹è§‚è¯»é”åæ˜¯å¦æœ‰å…¶ä»–å†™é”å‘ç”Ÿ
            stamp = stampedLock.readLock(); // è·å–ä¸€ä¸ªæ‚²è§‚è¯»é”
            try {
                currentX = x;
                currentY = y;
            } finally {
                stampedLock.unlockRead(stamp); // é‡Šæ”¾æ‚²è§‚è¯»é”
            }
        }
        return Math.sqrt(currentX * currentX + currentY * currentY);
    }
}

```

å’ŒReadWriteLockç›¸æ¯”ï¼Œå†™å…¥çš„åŠ é”æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œä¸åŒçš„æ˜¯è¯»å–ã€‚æ³¨æ„åˆ°é¦–å…ˆæˆ‘ä»¬é€šè¿‡tryOptimisticRead()è·å–ä¸€ä¸ªä¹è§‚è¯»é”ï¼Œå¹¶è¿”å›ç‰ˆæœ¬å·ã€‚æ¥ç€è¿›è¡Œè¯»å–ï¼Œè¯»å–å®Œæˆåï¼Œæˆ‘ä»¬é€šè¿‡validate()å»éªŒè¯ç‰ˆæœ¬å·ï¼Œå¦‚æœåœ¨è¯»å–è¿‡ç¨‹ä¸­æ²¡æœ‰å†™å…¥ï¼Œç‰ˆæœ¬å·ä¸å˜ï¼ŒéªŒè¯æˆåŠŸï¼Œæˆ‘ä»¬å°±å¯ä»¥æ”¾å¿ƒåœ°ç»§ç»­åç»­æ“ä½œã€‚å¦‚æœåœ¨è¯»å–è¿‡ç¨‹ä¸­æœ‰å†™å…¥ï¼Œç‰ˆæœ¬å·ä¼šå‘ç”Ÿå˜åŒ–ï¼ŒéªŒè¯å°†å¤±è´¥ã€‚åœ¨å¤±è´¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†é€šè¿‡è·å–æ‚²è§‚è¯»é”å†æ¬¡è¯»å–ã€‚ç”±äºå†™å…¥çš„æ¦‚ç‡ä¸é«˜ï¼Œç¨‹åºåœ¨ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯ä»¥é€šè¿‡ä¹è§‚è¯»é”è·å–æ•°æ®ï¼Œæå°‘æ•°æƒ…å†µä¸‹ä½¿ç”¨æ‚²è§‚è¯»é”è·å–æ•°æ®ã€‚

å¯è§ï¼ŒStampedLockæŠŠè¯»é”ç»†åˆ†ä¸ºä¹è§‚è¯»å’Œæ‚²è§‚è¯»ï¼Œèƒ½è¿›ä¸€æ­¥æå‡å¹¶å‘æ•ˆç‡ã€‚ä½†è¿™ä¹Ÿæ˜¯æœ‰ä»£ä»·çš„ï¼šä¸€æ˜¯ä»£ç æ›´åŠ å¤æ‚ï¼ŒäºŒæ˜¯StampedLockæ˜¯ä¸å¯é‡å…¥é”ï¼Œä¸èƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­åå¤è·å–åŒä¸€ä¸ªé”ã€‚

StampedLockè¿˜æä¾›äº†æ›´å¤æ‚çš„å°†æ‚²è§‚è¯»é”å‡çº§ä¸ºå†™é”çš„åŠŸèƒ½ï¼Œå®ƒä¸»è¦ä½¿ç”¨åœ¨if-then-updateçš„åœºæ™¯ï¼šå³å…ˆè¯»ï¼Œå¦‚æœè¯»çš„æ•°æ®æ»¡è¶³æ¡ä»¶ï¼Œå°±è¿”å›ï¼Œå¦‚æœè¯»çš„æ•°æ®ä¸æ»¡è¶³æ¡ä»¶ï¼Œå†å°è¯•å†™ã€‚

å°ç»“
StampedLockæä¾›äº†ä¹è§‚è¯»é”ï¼Œå¯å–ä»£ReadWriteLockä»¥è¿›ä¸€æ­¥æå‡å¹¶å‘æ€§èƒ½ï¼›

StampedLockæ˜¯ä¸å¯é‡å…¥é”ã€‚

### 5.8 ä½¿ç”¨Semaphore

å‰é¢æˆ‘ä»¬è®²äº†å„ç§é”çš„å®ç°ï¼Œæœ¬è´¨ä¸Šé”çš„ç›®çš„æ˜¯ä¿æŠ¤ä¸€ç§å—é™èµ„æºï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—®ï¼ˆReentrantLockï¼‰ï¼Œæˆ–è€…åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å†™å…¥ï¼ˆReadWriteLockï¼‰ã€‚

è¿˜æœ‰ä¸€ç§å—é™èµ„æºï¼Œå®ƒéœ€è¦ä¿è¯åŒä¸€æ—¶åˆ»æœ€å¤šæœ‰Nä¸ªçº¿ç¨‹èƒ½è®¿é—®ï¼Œæ¯”å¦‚åŒä¸€æ—¶åˆ»æœ€å¤šåˆ›å»º100ä¸ªæ•°æ®åº“è¿æ¥ï¼Œæœ€å¤šå…è®¸10ä¸ªç”¨æˆ·ä¸‹è½½ç­‰ã€‚

è¿™ç§é™åˆ¶æ•°é‡çš„é”ï¼Œå¦‚æœç”¨Lockæ•°ç»„æ¥å®ç°ï¼Œå°±å¤ªéº»çƒ¦äº†ã€‚

è¿™ç§æƒ…å†µå°±å¯ä»¥ä½¿ç”¨Semaphoreï¼Œä¾‹å¦‚ï¼Œæœ€å¤šå…è®¸3ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼š

```java
public class AccessLimitControl {
    // ä»»æ„æ—¶åˆ»ä»…å…è®¸æœ€å¤š3ä¸ªçº¿ç¨‹è·å–è®¸å¯:
    final Semaphore semaphore = new Semaphore(3);

    public String access() throws Exception {
        // å¦‚æœè¶…è¿‡äº†è®¸å¯æ•°é‡,å…¶ä»–çº¿ç¨‹å°†åœ¨æ­¤ç­‰å¾…:
        semaphore.acquire();
        try {
            // TODO:
            return UUID.randomUUID().toString();
        } finally {
            semaphore.release();
        }
    }
}

```

ä½¿ç”¨Semaphoreå…ˆè°ƒç”¨acquire()è·å–ï¼Œç„¶åé€šè¿‡try ... finallyä¿è¯åœ¨finallyä¸­é‡Šæ”¾ã€‚

è°ƒç”¨acquire()å¯èƒ½ä¼šè¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°æ»¡è¶³æ¡ä»¶ä¸ºæ­¢ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨tryAcquire()æŒ‡å®šç­‰å¾…æ—¶é—´ï¼š

```java
if (semaphore.tryAcquire(3, TimeUnit.SECONDS)) {
    // æŒ‡å®šç­‰å¾…æ—¶é—´3ç§’å†…è·å–åˆ°è®¸å¯:
    try {
        // TODO:
    } finally {
        semaphore.release();
    }
}
```

Semaphoreæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªä¿¡å·è®¡æ•°å™¨ï¼Œç”¨äºé™åˆ¶åŒä¸€æ—¶é—´çš„æœ€å¤§è®¿é—®æ•°é‡ã€‚

å°ç»“
å¦‚æœè¦å¯¹æŸä¸€å—é™èµ„æºè¿›è¡Œé™æµè®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨Semaphoreï¼Œä¿è¯åŒä¸€æ—¶é—´æœ€å¤šNä¸ªçº¿ç¨‹è®¿é—®å—é™èµ„æºã€‚

### 5.9 ä½¿ç”¨Concurrenté›†åˆ

æˆ‘ä»¬åœ¨å‰é¢å·²ç»é€šè¿‡ReentrantLockå’ŒConditionå®ç°äº†ä¸€ä¸ªBlockingQueueï¼š

```java
public class TaskQueue {
    private final Lock lock = new ReentrantLock();
    private final Condition condition = lock.newCondition();
    private Queue<String> queue = new LinkedList<>();

    public void addTask(String s) {
        lock.lock();
        try {
            queue.add(s);
            condition.signalAll();
        } finally {
            lock.unlock();
        }
    }

    public String getTask() {
        lock.lock();
        try {
            while (queue.isEmpty()) {
                condition.await();
            }
            return queue.remove();
        } finally {
            lock.unlock();
        }
    }
}

```

BlockingQueueçš„æ„æ€å°±æ˜¯è¯´ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¿™ä¸ªTaskQueueçš„getTask()æ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•å†…éƒ¨å¯èƒ½ä¼šè®©çº¿ç¨‹å˜æˆç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°é˜Ÿåˆ—æ¡ä»¶æ»¡è¶³ä¸ä¸ºç©ºï¼Œçº¿ç¨‹è¢«å”¤é†’åï¼ŒgetTask()æ–¹æ³•æ‰ä¼šè¿”å›ã€‚

å› ä¸ºBlockingQueueéå¸¸æœ‰ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¿…è‡ªå·±ç¼–å†™ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨Javaæ ‡å‡†åº“çš„java.util.concurrentåŒ…æä¾›çš„çº¿ç¨‹å®‰å…¨çš„é›†åˆï¼šArrayBlockingQueueã€‚

é™¤äº†BlockingQueueå¤–ï¼Œé’ˆå¯¹Listã€Mapã€Setã€Dequeç­‰ï¼Œjava.util.concurrentåŒ…ä¹Ÿæä¾›äº†å¯¹åº”çš„å¹¶å‘é›†åˆç±»ã€‚æˆ‘ä»¬å½’çº³ä¸€ä¸‹ï¼š


interface	non-thread-safe	thread-safe
List	ArrayList	CopyOnWriteArrayList
Map	HashMap	ConcurrentHashMap
Set	HashSet / TreeSet	CopyOnWriteArraySet
Queue	ArrayDeque / LinkedList	ArrayBlockingQueue / LinkedBlockingQueue
Deque	ArrayDeque / LinkedList	LinkedBlockingDeque
ä½¿ç”¨è¿™äº›å¹¶å‘é›†åˆä¸ä½¿ç”¨éçº¿ç¨‹å®‰å…¨çš„é›†åˆç±»å®Œå…¨ç›¸åŒã€‚æˆ‘ä»¬ä»¥ConcurrentHashMapä¸ºä¾‹ï¼š


ä½¿ç”¨è¿™äº›å¹¶å‘é›†åˆä¸ä½¿ç”¨éçº¿ç¨‹å®‰å…¨çš„é›†åˆç±»å®Œå…¨ç›¸åŒã€‚æˆ‘ä»¬ä»¥ConcurrentHashMapä¸ºä¾‹ï¼š

```java
Map<String, String> map = new ConcurrentHashMap<>();
// åœ¨ä¸åŒçš„çº¿ç¨‹è¯»å†™:
map.put("A", "1");
map.put("B", "2");
map.get("A", "1");
```

å› ä¸ºæ‰€æœ‰çš„åŒæ­¥å’ŒåŠ é”çš„é€»è¾‘éƒ½åœ¨é›†åˆå†…éƒ¨å®ç°ï¼Œå¯¹å¤–éƒ¨è°ƒç”¨è€…æ¥è¯´ï¼Œåªéœ€è¦æ­£å¸¸æŒ‰æ¥å£å¼•ç”¨ï¼Œå…¶ä»–ä»£ç å’ŒåŸæ¥çš„éçº¿ç¨‹å®‰å…¨ä»£ç å®Œå…¨ä¸€æ ·ã€‚å³å½“æˆ‘ä»¬éœ€è¦å¤šçº¿ç¨‹è®¿é—®æ—¶ï¼ŒæŠŠï¼š

```java
Map<String, String> map = new HashMap<>();
```
æ”¹ä¸ºï¼š
```java
Map<String, String> map = new ConcurrentHashMap<>();

```

å°±å¯ä»¥äº†ã€‚

java.util.Collectionså·¥å…·ç±»è¿˜æä¾›äº†ä¸€ä¸ªæ—§çš„çº¿ç¨‹å®‰å…¨é›†åˆè½¬æ¢å™¨ï¼Œå¯ä»¥è¿™ä¹ˆç”¨ï¼š

```java
Map unsafeMap = new HashMap();
Map threadSafeMap = Collections.synchronizedMap(unsafeMap);

```

ä½†æ˜¯å®ƒå®é™…ä¸Šæ˜¯ç”¨ä¸€ä¸ªåŒ…è£…ç±»åŒ…è£…äº†éçº¿ç¨‹å®‰å…¨çš„Mapï¼Œç„¶åå¯¹æ‰€æœ‰è¯»å†™æ–¹æ³•éƒ½ç”¨synchronizedåŠ é”ï¼Œè¿™æ ·è·å¾—çš„çº¿ç¨‹å®‰å…¨é›†åˆçš„æ€§èƒ½æ¯”java.util.concurrenté›†åˆè¦ä½å¾ˆå¤šï¼Œæ‰€ä»¥ä¸æ¨èä½¿ç”¨ã€‚

å°ç»“
ä½¿ç”¨java.util.concurrentåŒ…æä¾›çš„çº¿ç¨‹å®‰å…¨çš„å¹¶å‘é›†åˆå¯ä»¥å¤§å¤§ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼š

å¤šçº¿ç¨‹åŒæ—¶è¯»å†™å¹¶å‘é›†åˆæ˜¯å®‰å…¨çš„ï¼›

å°½é‡ä½¿ç”¨Javaæ ‡å‡†åº“æä¾›çš„å¹¶å‘é›†åˆï¼Œé¿å…è‡ªå·±ç¼–å†™åŒæ­¥ä»£ç ã€‚


### 5.10

Javaçš„java.util.concurrentåŒ…é™¤äº†æä¾›åº•å±‚é”ã€å¹¶å‘é›†åˆå¤–ï¼Œè¿˜æä¾›äº†ä¸€ç»„åŸå­æ“ä½œçš„å°è£…ç±»ï¼Œå®ƒä»¬ä½äºjava.util.concurrent.atomicåŒ…ã€‚

æˆ‘ä»¬ä»¥AtomicIntegerä¸ºä¾‹ï¼Œå®ƒæä¾›çš„ä¸»è¦æ“ä½œæœ‰ï¼š

+ å¢åŠ å€¼å¹¶è¿”å›æ–°å€¼ï¼šint addAndGet(int delta)
+ åŠ 1åè¿”å›æ–°å€¼ï¼šint incrementAndGet()
+ è·å–å½“å‰å€¼ï¼šint get()
+ ç”¨CASæ–¹å¼è®¾ç½®ï¼šint compareAndSet(int expect, int update)

Atomicç±»æ˜¯é€šè¿‡æ— é”ï¼ˆlock-freeï¼‰çš„æ–¹å¼å®ç°çš„çº¿ç¨‹å®‰å…¨ï¼ˆthread-safeï¼‰è®¿é—®ã€‚å®ƒçš„ä¸»è¦åŸç†æ˜¯åˆ©ç”¨äº†CASï¼šCompare and Setã€‚

å¦‚æœæˆ‘ä»¬è‡ªå·±é€šè¿‡CASç¼–å†™incrementAndGet()ï¼Œå®ƒå¤§æ¦‚é•¿è¿™æ ·ï¼š

```java
public int incrementAndGet(AtomicInteger var) {
    int prev, next;
    do {
        prev = var.get();
        next = prev + 1;
    } while ( ! var.compareAndSet(prev, next));
    return next;
}
```

CASæ˜¯æŒ‡ï¼Œåœ¨è¿™ä¸ªæ“ä½œä¸­ï¼Œå¦‚æœAtomicIntegerçš„å½“å‰å€¼æ˜¯prevï¼Œé‚£ä¹ˆå°±æ›´æ–°ä¸ºnextï¼Œè¿”å›trueã€‚å¦‚æœAtomicIntegerçš„å½“å‰å€¼ä¸æ˜¯prevï¼Œå°±ä»€ä¹ˆä¹Ÿä¸å¹²ï¼Œè¿”å›falseã€‚é€šè¿‡CASæ“ä½œå¹¶é…åˆdo ... whileå¾ªç¯ï¼Œå³ä½¿å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†AtomicIntegerçš„å€¼ï¼Œæœ€ç»ˆçš„ç»“æœä¹Ÿæ˜¯æ­£ç¡®çš„ã€‚

æˆ‘ä»¬åˆ©ç”¨AtomicLongå¯ä»¥ç¼–å†™ä¸€ä¸ªå¤šçº¿ç¨‹å®‰å…¨çš„å…¨å±€å”¯ä¸€IDç”Ÿæˆå™¨ï¼š

```java
class IdGenerator {
    AtomicLong var = new AtomicLong(0);

    public long getNextId() {
        return var.incrementAndGet();
    }
}

```

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ç›´æ¥ç”¨do ... whileå¾ªç¯è°ƒç”¨compareAndSetå®ç°å¤æ‚çš„å¹¶å‘æ“ä½œï¼Œè€Œæ˜¯ç”¨incrementAndGet()è¿™æ ·çš„å°è£…å¥½çš„æ–¹æ³•ï¼Œå› æ­¤ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ã€‚

åœ¨é«˜åº¦ç«äº‰çš„æƒ…å†µä¸‹ï¼Œè¿˜å¯ä»¥ä½¿ç”¨Java 8æä¾›çš„LongAdderå’ŒLongAccumulatorã€‚

å°ç»“
ä½¿ç”¨java.util.concurrent.atomicæä¾›çš„åŸå­æ“ä½œå¯ä»¥ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼š

+ åŸå­æ“ä½œå®ç°äº†æ— é”çš„çº¿ç¨‹å®‰å…¨ï¼›
+ é€‚ç”¨äºè®¡æ•°å™¨ï¼Œç´¯åŠ å™¨ç­‰ã€‚


### åŒæ­¥æ–¹æ³•å’Œc++å¯¹æ¯”

ğŸ§µ ä¸€ã€åŸºç¡€çº¿ç¨‹åŒæ­¥ï¼šäº’æ–¥é”ï¼ˆé”ï¼‰

C++ | Java | è¯´æ˜
std::mutex | synchronized / ReentrantLock | Java ä¸­æœ€åŸºæœ¬çš„åŒæ­¥æœºåˆ¶å°±æ˜¯ synchronizedï¼Œç±»ä¼¼ C++ çš„ mutex
std::lock_guard<std::mutex> | synchronized è‡ªåŠ¨è§£é” | Java ä¸­ synchronized æ˜¯éšå¼é”å®š+è§£é”ï¼Œä¸éœ€è¦é¢å¤– RAII
std::unique_lock | ReentrantLock | Java æä¾›äº†æ›´çµæ´»çš„ Lock æ¥å£ï¼Œå¯¹åº” C++ ä¸­çš„çµæ´»åŠ é”è§£é”

ğŸ›ï¸ äºŒã€æ¡ä»¶å˜é‡ï¼šç­‰å¾…é€šçŸ¥æœºåˆ¶

C++ | Java | å¯¹åº”è¯´æ˜
std::condition_variable | Object.wait() / Object.notify() | Java ä¸­æ‰€æœ‰å¯¹è±¡éƒ½å¯ä»¥ç”¨ä½œæ¡ä»¶å˜é‡
condition_variable.wait(lock) | obj.wait()ï¼ˆé‡Šæ”¾é”ç­‰å¾…ï¼‰ | Java ä¼šè‡ªåŠ¨é‡Šæ”¾å¯¹åº”çš„ synchronized é”
notify_one() / notify_all() | notify() / notifyAll() | Java åŒæ ·æä¾›å•å”¤é†’å’Œå…¨å”¤é†’


ğŸ§² ä¸‰ã€åŸå­æ“ä½œ

C++ | Java | è¯´æ˜
std::atomic<int> | AtomicInteger | Java çš„åŸå­ç±»ä¹ŸåŸºäºåº•å±‚çš„ CAS æ“ä½œ
fetch_add, compare_exchange | incrementAndGet, compareAndSet | åŠŸèƒ½ç±»ä¼¼

ğŸª å››ã€æ›´é«˜çº§çš„åŒæ­¥å·¥å…·ç±»ï¼ˆJava ç‰¹æœ‰ï¼‰
Java é™¤äº†ä¸Šè¿°åŸºæœ¬åŒæ­¥æœºåˆ¶ï¼Œè¿˜æä¾›äº†ä¸€äº›æ›´é«˜çº§çš„å·¥å…·ç±»ï¼ˆJDK æä¾›ï¼‰ï¼š


Java å·¥å…· | ç”¨é€” | ç±»æ¯”ï¼ˆC++ ä¸­æ²¡æœ‰ç›´æ¥ç­‰ä»·ï¼‰
CountDownLatch | å€’è®¡æ—¶å™¨ï¼Œç­‰å¾… N ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œ | éœ€è¦è‡ªå†™ç±»ä¼¼é€»è¾‘
CyclicBarrier | ä¸€ç»„çº¿ç¨‹éƒ½å‡†å¤‡å¥½ååŒæ—¶æ‰§è¡Œ | C++ ä¸­éœ€è‡ªå†™ Barrier
Semaphore | æ§åˆ¶è®¿é—®çº¿ç¨‹æ•° | POSIX æœ‰ä¿¡å·é‡ï¼ŒC++20 èµ·æ ‡å‡†æ”¯æŒ
ReadWriteLock | è¯»å†™åˆ†ç¦»é” | C++17 èµ·æ”¯æŒ shared_mutex

ğŸ§© äº”ã€å¯¹ç…§æ€»ç»“è¡¨

åŠŸèƒ½ | C++ | Java | æ˜¯å¦ç›´æ¥ç­‰ä»·
äº’æ–¥é” | std::mutex | synchronized, ReentrantLock | âœ…
è‡ªåŠ¨è§£é” | lock_guard | synchronized ä»£ç å— | âœ…
æ¡ä»¶å˜é‡ | condition_variable | Object.wait/notify | âœ…
åŸå­æ“ä½œ | std::atomic | AtomicXXX | âœ…
è¯»å†™é” | shared_mutexï¼ˆC++17ï¼‰ | ReadWriteLock | âœ…
ä¿¡å·é‡ | std::counting_semaphoreï¼ˆC++20ï¼‰ | Semaphore | âœ…
å€’è®¡æ—¶ | è‡ªå®ç° | CountDownLatch | ğŸ”ºï¼ˆJavaå†…å»ºæ›´å¥½ç”¨ï¼‰
æ …æ  | è‡ªå®ç° | CyclicBarrier | ğŸ”º
çº¿ç¨‹æ±  | std::thread + queue | ExecutorService | âœ…/ğŸ”º


## 6. ä½¿ç”¨çº¿ç¨‹æ± 

javaè¯­è¨€è™½ç„¶å†…ç½®äº†å¤šçº¿ç¨‹æ”¯æŒï¼Œå¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹éå¸¸æ–¹ä¾¿ï¼Œä½†æ˜¯ï¼Œåˆ›å»ºçº¿ç¨‹éœ€è¦æ“ä½œç³»ç»Ÿèµ„æºï¼ˆçº¿ç¨‹èµ„æºï¼Œæ ˆç©ºé—´ç­‰ï¼‰ï¼Œé¢‘ç¹åˆ›å»ºå’Œé”€æ¯å¤§é‡çº¿ç¨‹éœ€è¦æ¶ˆè€—å¤§é‡æ—¶é—´ã€‚

å¦‚æœå¯ä»¥å¤ç”¨ä¸€ç»„çº¿ç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â” execute  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Task1â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ThreadPool        â”‚
â”œâ”€â”€â”€â”€â”€â”¤          â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚Task2â”‚          â”‚â”‚Thread1â”‚â”‚Thread2â”‚â”‚
â”œâ”€â”€â”€â”€â”€â”¤          â”‚â””â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚Task3â”‚          â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚
â”œâ”€â”€â”€â”€â”€â”¤          â”‚â”‚Thread3â”‚â”‚Thread4â”‚â”‚
â”‚Task4â”‚          â”‚â””â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”¤          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚Task5â”‚
â”œâ”€â”€â”€â”€â”€â”¤
â”‚Task6â”‚
â””â”€â”€â”€â”€â”€â”˜
  ...
é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æŠŠå¾ˆå¤šå°ä»»åŠ¡è®©ä¸€ç»„çº¿ç¨‹æ¥æ‰§è¡Œï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä»»åŠ¡å¯¹åº”ä¸€ä¸ªæ–°çº¿ç¨‹ã€‚è¿™ç§èƒ½æ¥æ”¶å¤§é‡å°ä»»åŠ¡å¹¶è¿›è¡Œåˆ†å‘å¤„ç†çš„å°±æ˜¯çº¿ç¨‹æ± ã€‚

ç®€å•åœ°è¯´ï¼Œçº¿ç¨‹æ± å†…éƒ¨ç»´æŠ¤äº†è‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œæ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼Œè¿™äº›çº¿ç¨‹éƒ½å¤„äºç­‰å¾…çŠ¶æ€ã€‚å¦‚æœæœ‰æ–°ä»»åŠ¡ï¼Œå°±åˆ†é…ä¸€ä¸ªç©ºé—²çº¿ç¨‹æ‰§è¡Œã€‚å¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½å¤„äºå¿™ç¢ŒçŠ¶æ€ï¼Œæ–°ä»»åŠ¡è¦ä¹ˆæ”¾å…¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè¦ä¹ˆå¢åŠ ä¸€ä¸ªæ–°çº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚

Javaæ ‡å‡†åº“æä¾›äº†ExecutorServiceæ¥å£è¡¨ç¤ºçº¿ç¨‹æ± ï¼Œå®ƒçš„å…¸å‹ç”¨æ³•å¦‚ä¸‹ï¼š

```java
// åˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± :
ExecutorService executor = Executors.newFixedThreadPool(3);
// æäº¤ä»»åŠ¡:
executor.submit(task1);
executor.submit(task2);
executor.submit(task3);
executor.submit(task4);
executor.submit(task5);

```

å› ä¸ºExecutorServiceåªæ˜¯æ¥å£ï¼ŒJavaæ ‡å‡†åº“æä¾›çš„å‡ ä¸ªå¸¸ç”¨å®ç°ç±»æœ‰ï¼š

+ FixedThreadPoolï¼šçº¿ç¨‹æ•°å›ºå®šçš„çº¿ç¨‹æ± ï¼›
+ CachedThreadPoolï¼šçº¿ç¨‹æ•°æ ¹æ®ä»»åŠ¡åŠ¨æ€è°ƒæ•´çš„çº¿ç¨‹æ± ï¼›
+ SingleThreadExecutorï¼šä»…å•çº¿ç¨‹æ‰§è¡Œçš„çº¿ç¨‹æ± ã€‚

åˆ›å»ºè¿™äº›çº¿ç¨‹æ± çš„æ–¹æ³•éƒ½è¢«å°è£…åˆ°Executorsè¿™ä¸ªç±»ä¸­ã€‚æˆ‘ä»¬ä»¥FixedThreadPoolä¸ºä¾‹ï¼Œçœ‹çœ‹çº¿ç¨‹æ± çš„æ‰§è¡Œé€»è¾‘ï¼š

```java
// thread-pool
import java.util.concurrent.*;

public class Main {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± :
        ExecutorService es = Executors.newFixedThreadPool(4);
        for (int i = 0; i < 6; i++) {
            es.submit(new Task("" + i));
        }
        // å…³é—­çº¿ç¨‹æ± :
        es.shutdown();
    }
}

class Task implements Runnable {
    private final String name;

    public Task(String name) {
        this.name = name;
    }

    @Override
    public void run() {
        System.out.println("start task " + name);
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
        }
        System.out.println("end task " + name);
    }
}

```

æˆ‘ä»¬è§‚å¯Ÿæ‰§è¡Œç»“æœï¼Œä¸€æ¬¡æ€§æ”¾å…¥6ä¸ªä»»åŠ¡ï¼Œç”±äºçº¿ç¨‹æ± åªæœ‰å›ºå®šçš„4ä¸ªçº¿ç¨‹ï¼Œå› æ­¤ï¼Œå‰4ä¸ªä»»åŠ¡ä¼šåŒæ—¶æ‰§è¡Œï¼Œç­‰åˆ°æœ‰çº¿ç¨‹ç©ºé—²åï¼Œæ‰ä¼šæ‰§è¡Œåé¢çš„ä¸¤ä¸ªä»»åŠ¡ã€‚

çº¿ç¨‹æ± åœ¨ç¨‹åºç»“æŸçš„æ—¶å€™è¦å…³é—­ã€‚ä½¿ç”¨shutdown()æ–¹æ³•å…³é—­çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå®ƒä¼šç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å…ˆå®Œæˆï¼Œç„¶åå†å…³é—­ã€‚shutdownNow()ä¼šç«‹åˆ»åœæ­¢æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼ŒawaitTermination()åˆ™ä¼šç­‰å¾…æŒ‡å®šçš„æ—¶é—´è®©çº¿ç¨‹æ± å…³é—­ã€‚

å¦‚æœæˆ‘ä»¬æŠŠçº¿ç¨‹æ± æ”¹ä¸ºCachedThreadPoolï¼Œç”±äºè¿™ä¸ªçº¿ç¨‹æ± çš„å®ç°ä¼šæ ¹æ®ä»»åŠ¡æ•°é‡åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± çš„å¤§å°ï¼Œæ‰€ä»¥6ä¸ªä»»åŠ¡å¯ä¸€æ¬¡æ€§å…¨éƒ¨åŒæ—¶æ‰§è¡Œã€‚

å¦‚æœæˆ‘ä»¬æƒ³æŠŠçº¿ç¨‹æ± çš„å¤§å°é™åˆ¶åœ¨4ï½10ä¸ªä¹‹é—´åŠ¨æ€è°ƒæ•´æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬æŸ¥çœ‹Executors.newCachedThreadPool()æ–¹æ³•çš„æºç ï¼š

```java
public static ExecutorService newCachedThreadPool() {
    return new ThreadPoolExecutor(
            0, Integer.MAX_VALUE,
            60L, TimeUnit.SECONDS,
            new SynchronousQueue<Runnable>());
}
```

å› æ­¤ï¼Œæƒ³åˆ›å»ºæŒ‡å®šåŠ¨æ€èŒƒå›´çš„çº¿ç¨‹æ± ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼š

```java
int min = 4;
int max = 10;
ExecutorService es = new ThreadPoolExecutor(
        min, max,
        60L, TimeUnit.SECONDS,
        new SynchronousQueue<Runnable>());
```

ScheduledThreadPool

è¿˜æœ‰ä¸€ç§ä»»åŠ¡ï¼Œéœ€è¦å®šæœŸåå¤æ‰§è¡Œï¼Œä¾‹å¦‚ï¼Œæ¯ç§’åˆ·æ–°è¯åˆ¸ä»·æ ¼ã€‚è¿™ç§ä»»åŠ¡æœ¬èº«å›ºå®šï¼Œéœ€è¦åå¤æ‰§è¡Œçš„ï¼Œå¯ä»¥ä½¿ç”¨ScheduledThreadPoolã€‚æ”¾å…¥ScheduledThreadPoolçš„ä»»åŠ¡å¯ä»¥å®šæœŸåå¤æ‰§è¡Œã€‚

åˆ›å»ºä¸€ä¸ªScheduledThreadPoolä»ç„¶æ˜¯é€šè¿‡Executorsç±»ï¼š

```java
ScheduledExecutorService ses = Executors.newScheduledThreadPool(4);
```

æˆ‘ä»¬å¯ä»¥æäº¤ä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œå®ƒä¼šåœ¨æŒ‡å®šå»¶è¿Ÿååªæ‰§è¡Œä¸€æ¬¡
```java
// 1ç§’åæ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡:
ses.schedule(new Task("one-time"), 1, TimeUnit.SECONDS);
```

å¦‚æœä»»åŠ¡ä»¥å›ºå®šçš„æ¯3ç§’æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š
```java
// 2ç§’åå¼€å§‹æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œæ¯3ç§’æ‰§è¡Œ:
ses.scheduleAtFixedRate(new Task("fixed-rate"), 2, 3, TimeUnit.SECONDS);
```

å¦‚æœä»»åŠ¡ä»¥å›ºå®šçš„3ç§’ä¸ºé—´éš”æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š
```java
// 2ç§’åå¼€å§‹æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œä»¥3ç§’ä¸ºé—´éš”æ‰§è¡Œ:
ses.scheduleWithFixedDelay(new Task("fixed-delay"), 2, 3, TimeUnit.SECONDS);
```

æ³¨æ„FixedRateå’ŒFixedDelayçš„åŒºåˆ«ã€‚FixedRateæ˜¯æŒ‡ä»»åŠ¡æ€»æ˜¯ä»¥å›ºå®šæ—¶é—´é—´éš”è§¦å‘ï¼Œä¸ç®¡ä»»åŠ¡æ‰§è¡Œå¤šé•¿æ—¶é—´ï¼š

â”‚â–‘â–‘â–‘â–‘   â”‚â–‘â–‘â–‘â–‘â–‘â–‘ â”‚â–‘â–‘â–‘    â”‚â–‘â–‘â–‘â–‘â–‘  â”‚â–‘â–‘â–‘  
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–¶
â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚
è€ŒFixedDelayæ˜¯æŒ‡ï¼Œä¸Šä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç­‰å¾…å›ºå®šçš„æ—¶é—´é—´éš”ï¼Œå†æ‰§è¡Œä¸‹ä¸€æ¬¡ä»»åŠ¡ï¼š

â”‚â–‘â–‘â–‘â”‚       â”‚â–‘â–‘â–‘â–‘â–‘â”‚       â”‚â–‘â–‘â”‚       â”‚â–‘
â””â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶
    â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚     â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚  â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚
å› æ­¤ï¼Œä½¿ç”¨ScheduledThreadPoolæ—¶ï¼Œæˆ‘ä»¬è¦æ ¹æ®éœ€è¦é€‰æ‹©æ‰§è¡Œä¸€æ¬¡ã€FixedRateæ‰§è¡Œè¿˜æ˜¯FixedDelayæ‰§è¡Œã€‚

+ åœ¨FixedRateæ¨¡å¼ä¸‹ï¼Œå‡è®¾æ¯ç§’è§¦å‘ï¼Œå¦‚æœæŸæ¬¡ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡1ç§’ï¼Œåç»­ä»»åŠ¡ä¼šä¸ä¼šå¹¶å‘æ‰§è¡Œï¼Ÿ
+ å¦‚æœä»»åŠ¡æŠ›å‡ºäº†å¼‚å¸¸ï¼Œåç»­ä»»åŠ¡æ˜¯å¦ç»§ç»­æ‰§è¡Œï¼Ÿ

Javaæ ‡å‡†åº“è¿˜æä¾›äº†ä¸€ä¸ªjava.util.Timerç±»ï¼Œè¿™ä¸ªç±»ä¹Ÿå¯ä»¥å®šæœŸæ‰§è¡Œä»»åŠ¡ï¼Œä½†æ˜¯ï¼Œä¸€ä¸ªTimerä¼šå¯¹åº”ä¸€ä¸ªThreadï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ªTimeråªèƒ½å®šæœŸæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œå¤šä¸ªå®šæ—¶ä»»åŠ¡å¿…é¡»å¯åŠ¨å¤šä¸ªTimerï¼Œè€Œä¸€ä¸ªScheduledThreadPoolå°±å¯ä»¥è°ƒåº¦å¤šä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ç”¨ScheduledThreadPoolå–ä»£æ—§çš„Timerã€‚


## 7. ä½¿ç”¨Future

åœ¨æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„æ—¶å€™ï¼Œä½¿ç”¨Javaæ ‡å‡†åº“æä¾›çš„çº¿ç¨‹æ± æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚æˆ‘ä»¬æäº¤çš„ä»»åŠ¡åªéœ€è¦å®ç°Runnableæ¥å£ï¼Œå°±å¯ä»¥è®©çº¿ç¨‹æ± å»æ‰§è¡Œï¼š

```java
class Task implements Runnable {
    public String result;

    public void run() {
        this.result = longTimeCalculation(); 
    }
}
```

Runnableæ¥å£æœ‰ä¸ªé—®é¢˜ï¼Œå®ƒçš„æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ã€‚å¦‚æœä»»åŠ¡éœ€è¦ä¸€ä¸ªè¿”å›ç»“æœï¼Œé‚£ä¹ˆåªèƒ½ä¿å­˜åˆ°å˜é‡ï¼Œè¿˜è¦æä¾›é¢å¤–çš„æ–¹æ³•è¯»å–ï¼Œéå¸¸ä¸ä¾¿ã€‚æ‰€ä»¥ï¼ŒJavaæ ‡å‡†åº“è¿˜æä¾›äº†ä¸€ä¸ªCallableæ¥å£ï¼Œå’ŒRunnableæ¥å£æ¯”ï¼Œå®ƒå¤šäº†ä¸€ä¸ªè¿”å›å€¼ï¼š

```java
class Task implements Callable<String> {
    public String call() throws Exception {
        return longTimeCalculation(); 
    }
}
```

å¹¶ä¸”Callableæ¥å£æ˜¯ä¸€ä¸ªæ³›å‹æ¥å£ï¼Œå¯ä»¥è¿”å›æŒ‡å®šç±»å‹çš„ç»“æœã€‚

ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œå¦‚ä½•è·å¾—å¼‚æ­¥æ‰§è¡Œçš„ç»“æœï¼Ÿ

å¦‚æœä»”ç»†çœ‹ExecutorService.submit()æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®ƒè¿”å›äº†ä¸€ä¸ªFutureç±»å‹ï¼Œä¸€ä¸ªFutureç±»å‹çš„å®ä¾‹ä»£è¡¨ä¸€ä¸ªæœªæ¥èƒ½è·å–ç»“æœçš„å¯¹è±¡ï¼š

```java
ExecutorService executor = Executors.newFixedThreadPool(4); 
// å®šä¹‰ä»»åŠ¡:
Callable<String> task = new Task();
// æäº¤ä»»åŠ¡å¹¶è·å¾—Future:
Future<String> future = executor.submit(task);
// ä»Futureè·å–å¼‚æ­¥æ‰§è¡Œè¿”å›çš„ç»“æœ:
String result = future.get(); // å¯èƒ½é˜»å¡

```

å½“æˆ‘ä»¬æäº¤ä¸€ä¸ªCallableä»»åŠ¡åï¼Œæˆ‘ä»¬ä¼šåŒæ—¶è·å¾—ä¸€ä¸ªFutureå¯¹è±¡ï¼Œç„¶åï¼Œæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹æŸä¸ªæ—¶åˆ»è°ƒç”¨Futureå¯¹è±¡çš„get()æ–¹æ³•ï¼Œå°±å¯ä»¥è·å¾—å¼‚æ­¥æ‰§è¡Œçš„ç»“æœã€‚åœ¨è°ƒç”¨get()æ—¶ï¼Œå¦‚æœå¼‚æ­¥ä»»åŠ¡å·²ç»å®Œæˆï¼Œæˆ‘ä»¬å°±ç›´æ¥è·å¾—ç»“æœã€‚å¦‚æœå¼‚æ­¥ä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œé‚£ä¹ˆget()ä¼šé˜»å¡ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆåæ‰è¿”å›ç»“æœã€‚

ä¸€ä¸ªFuture<V>æ¥å£è¡¨ç¤ºä¸€ä¸ªæœªæ¥å¯èƒ½ä¼šè¿”å›çš„ç»“æœï¼Œå®ƒå®šä¹‰çš„æ–¹æ³•æœ‰ï¼š

+ get()ï¼šè·å–ç»“æœï¼ˆå¯èƒ½ä¼šç­‰å¾…ï¼‰
+ get(long timeout, TimeUnit unit)ï¼šè·å–ç»“æœï¼Œä½†åªç­‰å¾…æŒ‡å®šçš„æ—¶é—´ï¼›
+ cancel(boolean mayInterruptIfRunning)ï¼šå–æ¶ˆå½“å‰ä»»åŠ¡ï¼›
+ isDone()ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²å®Œæˆã€‚

## 8. ä½¿ç”¨CompletableFuture

ä½¿ç”¨Futureè·å¾—å¼‚æ­¥æ‰§è¡Œç»“æœæ—¶ï¼Œè¦ä¹ˆè°ƒç”¨é˜»å¡æ–¹æ³•get()ï¼Œè¦ä¹ˆè½®è¯¢çœ‹isDone()æ˜¯å¦ä¸ºtrueï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºä¸»çº¿ç¨‹ä¹Ÿä¼šè¢«è¿«ç­‰å¾…ã€‚

ä»Java 8å¼€å§‹å¼•å…¥äº†CompletableFutureï¼Œå®ƒé’ˆå¯¹Futureåšäº†æ”¹è¿›ï¼Œå¯ä»¥ä¼ å…¥å›è°ƒå¯¹è±¡ï¼Œå½“å¼‚æ­¥ä»»åŠ¡å®Œæˆæˆ–è€…å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨å›è°ƒå¯¹è±¡çš„å›è°ƒæ–¹æ³•ã€‚

æˆ‘ä»¬ä»¥è·å–è‚¡ç¥¨ä»·æ ¼ä¸ºä¾‹ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨CompletableFutureï¼š

```java
// CompletableFuture
import java.util.concurrent.CompletableFuture;

public class Main {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºå¼‚æ­¥æ‰§è¡Œä»»åŠ¡:
        CompletableFuture<Double> cf = CompletableFuture.supplyAsync(Main::fetchPrice);
        // å¦‚æœæ‰§è¡ŒæˆåŠŸ:
        cf.thenAccept((result) -> {
            System.out.println("price: " + result);
        });
        // å¦‚æœæ‰§è¡Œå¼‚å¸¸:
        cf.exceptionally((e) -> {
            e.printStackTrace();
            return null;
        });
        // ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
        Thread.sleep(200);
    }

    static Double fetchPrice() {
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
        }
        if (Math.random() < 0.3) {
            throw new RuntimeException("fetch price failed!");
        }
        return 5 + Math.random() * 20;
    }
}

```

åˆ›å»ºä¸€ä¸ªCompletableFutureæ˜¯é€šè¿‡CompletableFuture.supplyAsync()å®ç°çš„ï¼Œå®ƒéœ€è¦ä¸€ä¸ªå®ç°äº†Supplieræ¥å£çš„å¯¹è±¡

```java
public interface Supplier<T> {
    T get();
}
```

è¿™é‡Œæˆ‘ä»¬ç”¨lambdaè¯­æ³•ç®€åŒ–äº†ä¸€ä¸‹ï¼Œç›´æ¥ä¼ å…¥Main::fetchPriceï¼Œå› ä¸ºMain.fetchPrice()é™æ€æ–¹æ³•çš„ç­¾åç¬¦åˆSupplieræ¥å£çš„å®šä¹‰ï¼ˆé™¤äº†æ–¹æ³•åå¤–ï¼‰ã€‚

ç´§æ¥ç€ï¼ŒCompletableFutureå·²ç»è¢«æäº¤ç»™é»˜è®¤çš„çº¿ç¨‹æ± æ‰§è¡Œäº†ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰çš„æ˜¯CompletableFutureå®Œæˆæ—¶å’Œå¼‚å¸¸æ—¶éœ€è¦å›è°ƒçš„å®ä¾‹ã€‚å®Œæˆæ—¶ï¼ŒCompletableFutureä¼šè°ƒç”¨Consumerå¯¹è±¡ï¼š

```java
public interface Consumer<T> {
    void accept(T t);
}

```
å¼‚å¸¸æ—¶ï¼ŒCompletableFutureä¼šè°ƒç”¨Functionå¯¹è±¡ï¼š

```java
public interface Function<T, R> {
    R apply(T t);
}

```

è¿™é‡Œæˆ‘ä»¬éƒ½ç”¨lambdaè¯­æ³•ç®€åŒ–äº†ä»£ç ã€‚

å¯è§CompletableFutureçš„ä¼˜ç‚¹æ˜¯ï¼š

+ å¼‚æ­¥ä»»åŠ¡ç»“æŸæ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼›
+ å¼‚æ­¥ä»»åŠ¡å‡ºé”™æ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼›
+ ä¸»çº¿ç¨‹è®¾ç½®å¥½å›è°ƒåï¼Œä¸å†å…³å¿ƒå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œã€‚

å¦‚æœåªæ˜¯å®ç°äº†å¼‚æ­¥å›è°ƒæœºåˆ¶ï¼Œæˆ‘ä»¬è¿˜çœ‹ä¸å‡ºCompletableFutureç›¸æ¯”Futureçš„ä¼˜åŠ¿ã€‚CompletableFutureæ›´å¼ºå¤§çš„åŠŸèƒ½æ˜¯ï¼Œå¤šä¸ªCompletableFutureå¯ä»¥ä¸²è¡Œæ‰§è¡Œï¼Œä¾‹å¦‚ï¼Œå®šä¹‰ä¸¤ä¸ªCompletableFutureï¼Œç¬¬ä¸€ä¸ªCompletableFutureæ ¹æ®è¯åˆ¸åç§°æŸ¥è¯¢è¯åˆ¸ä»£ç ï¼Œç¬¬äºŒä¸ªCompletableFutureæ ¹æ®è¯åˆ¸ä»£ç æŸ¥è¯¢è¯åˆ¸ä»·æ ¼ï¼Œè¿™ä¸¤ä¸ªCompletableFutureå®ç°ä¸²è¡Œæ“ä½œå¦‚ä¸‹ï¼š


```java
// CompletableFuture
import java.util.concurrent.CompletableFuture;

public class Main {
    public static void main(String[] args) throws Exception {
        // ç¬¬ä¸€ä¸ªä»»åŠ¡:
        CompletableFuture<String> cfQuery = CompletableFuture.supplyAsync(() -> {
            return queryCode("ä¸­å›½çŸ³æ²¹");
        });
        // cfQueryæˆåŠŸåç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡:
        CompletableFuture<Double> cfFetch = cfQuery.thenApplyAsync((code) -> {
            return fetchPrice(code);
        });
        // cfFetchæˆåŠŸåæ‰“å°ç»“æœ:
        cfFetch.thenAccept((result) -> {
            System.out.println("price: " + result);
        });
        // ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
        Thread.sleep(2000);
    }

    static String queryCode(String name) {
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
        }
        return "601857";
    }

    static Double fetchPrice(String code) {
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
        }
        return 5 + Math.random() * 20;
    }
}

```

é™¤äº†ä¸²è¡Œæ‰§è¡Œå¤–ï¼Œå¤šä¸ªCompletableFutureè¿˜å¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š

åŒæ—¶ä»æ–°æµªå’Œç½‘æ˜“æŸ¥è¯¢è¯åˆ¸ä»£ç ï¼Œåªè¦ä»»æ„ä¸€ä¸ªè¿”å›ç»“æœï¼Œå°±è¿›è¡Œä¸‹ä¸€æ­¥æŸ¥è¯¢ä»·æ ¼ï¼ŒæŸ¥è¯¢ä»·æ ¼ä¹ŸåŒæ—¶ä»æ–°æµªå’Œç½‘æ˜“æŸ¥è¯¢ï¼Œåªè¦ä»»æ„ä¸€ä¸ªè¿”å›ç»“æœï¼Œå°±å®Œæˆæ“ä½œï¼š

```java
// CompletableFuture
import java.util.concurrent.CompletableFuture;

public class Main {
    public static void main(String[] args) throws Exception {
        // ä¸¤ä¸ªCompletableFutureæ‰§è¡Œå¼‚æ­¥æŸ¥è¯¢:
        CompletableFuture<String> cfQueryFromSina = CompletableFuture.supplyAsync(() -> {
            return queryCode("ä¸­å›½çŸ³æ²¹", "https://finance.sina.com.cn/code/");
        });
        CompletableFuture<String> cfQueryFrom163 = CompletableFuture.supplyAsync(() -> {
            return queryCode("ä¸­å›½çŸ³æ²¹", "https://money.163.com/code/");
        });

        // ç”¨anyOfåˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„CompletableFuture:
        CompletableFuture<Object> cfQuery = CompletableFuture.anyOf(cfQueryFromSina, cfQueryFrom163);

        // ä¸¤ä¸ªCompletableFutureæ‰§è¡Œå¼‚æ­¥æŸ¥è¯¢:
        CompletableFuture<Double> cfFetchFromSina = cfQuery.thenApplyAsync((code) -> {
            return fetchPrice((String) code, "https://finance.sina.com.cn/price/");
        });
        CompletableFuture<Double> cfFetchFrom163 = cfQuery.thenApplyAsync((code) -> {
            return fetchPrice((String) code, "https://money.163.com/price/");
        });

        // ç”¨anyOfåˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„CompletableFuture:
        CompletableFuture<Object> cfFetch = CompletableFuture.anyOf(cfFetchFromSina, cfFetchFrom163);

        // æœ€ç»ˆç»“æœ:
        cfFetch.thenAccept((result) -> {
            System.out.println("price: " + result);
        });
        // ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
        Thread.sleep(200);
    }

    static String queryCode(String name, String url) {
        System.out.println("query code from " + url + "...");
        try {
            Thread.sleep((long) (Math.random() * 100));
        } catch (InterruptedException e) {
        }
        return "601857";
    }

    static Double fetchPrice(String code, String url) {
        System.out.println("query price from " + url + "...");
        try {
            Thread.sleep((long) (Math.random() * 100));
        } catch (InterruptedException e) {
        }
        return 5 + Math.random() * 20;
    }
}
```

ä¸Šè¿°é€»è¾‘å®ç°çš„å¼‚æ­¥æŸ¥è¯¢è§„åˆ™å®é™…ä¸Šæ˜¯ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query Code  â”‚ â”‚ Query Code  â”‚
â”‚  from sina  â”‚ â”‚  from 163   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    anyOf    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query Price â”‚  â”‚ Query Price â”‚
â”‚  from sina  â”‚  â”‚  from 163   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    anyOf    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚Display Priceâ”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é™¤äº†anyOf()å¯ä»¥å®ç°â€œä»»æ„ä¸ªCompletableFutureåªè¦ä¸€ä¸ªæˆåŠŸâ€ï¼ŒallOf()å¯ä»¥å®ç°â€œæ‰€æœ‰CompletableFutureéƒ½å¿…é¡»æˆåŠŸâ€ï¼Œè¿™äº›ç»„åˆæ“ä½œå¯ä»¥å®ç°éå¸¸å¤æ‚çš„å¼‚æ­¥æµç¨‹æ§åˆ¶ã€‚

æœ€åæˆ‘ä»¬æ³¨æ„CompletableFutureçš„å‘½åè§„åˆ™ï¼š

+ xxx()ï¼šè¡¨ç¤ºè¯¥æ–¹æ³•å°†ç»§ç»­åœ¨å·²æœ‰çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼›
+ xxxAsync()ï¼šè¡¨ç¤ºå°†å¼‚æ­¥åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚



