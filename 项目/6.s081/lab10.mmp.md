# Lab: mmap (hard)
mmap 和 munmap 系统调用允许 UNIX 程序对其地址空间进行详细控制。它们可以用于进程之间共享内存，将文件映射到进程的地址空间中，以及作为用户级页错误处理方案的一部分，例如讲座中讨论的垃圾回收算法。在这个实验中，你将为 xv6 添加 mmap 和 munmap，重点关注内存映射文件。

mmap 可以以多种方式调用，但本实验只需要其子集的功能，相关于内存映射一个文件。你可以假设 addr 总是零，意味着内核应该决定映射文件的虚拟地址。mmap 返回这个地址，如果失败则返回 0xffffffffffffffff。length 是要映射的字节数，它可能与文件的长度不同。prot 指示内存是否应该被映射为可读、可写和/或可执行；你可以假设 prot 是 PROT_READ 或 PROT_WRITE 或两者兼有。flags 将是 MAP_SHARED，意味着对映射内存的修改应写回到文件中，或 MAP_PRIVATE，意味着修改不应写回。你不需要实现 flags 中的其他位。fd 是要映射的文件的打开文件描述符。你可以假设 offset 为零（这是文件中要映射的起始点）。

如果映射同一 MAP_SHARED 文件的进程不共享物理页面也是可以的。

munmap(addr, length) 应该移除在指定地址范围内的 mmap 映射。如果进程已经修改了内存，并且内存是以 MAP_SHARED 方式映射的，这些修改应首先写回到文件中。一个 munmap 调用可能只覆盖 mmap 区域的一部分，但你可以假设它要么在区域的开始处取消映射，要么在区域的结束处取消映射，或者取消整个区域的映射（但不会在区域的中间留下空洞）。

>你应该实现足够的 mmap 和 munmap 功能，以使 mmaptest 测试程序能够正常工作。如果 mmaptest 不使用某个 mmap 功能，你不需要实现那个功能。


提示：
  从将 _mmaptest 添加到 UPROGS 开始，以及添加 mmap 和 munmap 系统调用，以便编译 user/mmaptest.c。目前，只需在 mmap 和 munmap 中返回错误。我们已经在 kernel/fcntl.h 中为你定义了 PROT_READ 等宏。运行 mmaptest，它将在第一次 mmap 调用时失败。

  填充页面表：在响应页面错误时，懒惰地进行处理。即，mmap 不应分配物理内存或读取文件。相反，应在页面错误处理代码中完成这些操作（或由 usertrap 调用，如同懒惰页面分配实验中）。选择懒惰的原因是确保 mmap 大文件时速度较快，并且 mmap 比物理内存大的文件是可能的。

  跟踪每个进程的 mmap：定义一个对应于讲座 15 中描述的 VMA（虚拟内存区域）的结构，记录由 mmap 创建的虚拟内存范围的地址、长度、权限、文件等信息。由于 xv6 内核没有内存分配器，所以声明一个固定大小的 VMA 数组并根据需要从该数组中分配是可以的。大小为 16 应该足够。

  实现 mmap：在进程的地址空间中找到一个未使用的区域以映射文件，并将 VMA 添加到进程的映射区域表中。VMA 应包含一个指向文件结构的指针；mmap 应增加文件的引用计数，以确保当文件关闭时结构不会消失（提示：参见 filedup）。运行 mmaptest：第一次 mmap 应成功，但第一次访问映射的内存将导致页面错误并杀死 mmaptest。

  添加代码：在 mmap 区域中发生页面错误时，分配一页物理内存，将 4096 字节的相关文件读入该页，并将其映射到用户地址空间中。使用 readi 读取文件，它接受一个用于读取文件的偏移量参数（但你需要锁定/解锁传递给 readi 的 inode）。不要忘记正确设置页面的权限。运行 mmaptest；它应该到达第一个 munmap。

  实现 munmap：找到地址范围的 VMA 并取消映射指定的页面（提示：使用 uvmunmap）。如果 munmap 删除了以前 mmap 的所有页面，则应减少相应文件结构的引用计数。如果一个未映射的页面已被修改且文件是 MAP_SHARED 映射的，则将页面写回文件。参见 filewrite 以获取灵感。

  理想情况下，你的实现应该只写回程序实际修改的 MAP_SHARED 页面。RISC-V PTE 中的脏位（D）指示页面是否已被写入。然而，mmaptest 不检查未脏页面是否被写回，因此你可以在不查看 D 位的情况下写回页面。

  修改 exit：以 munmap 被调用的方式取消映射进程的映射区域。运行 mmaptest；mmap_test 应通过，但可能不会通过 fork_test。

  修改 fork：确保子进程具有与父进程相同的映射区域。不要忘记增加 VMA 的文件结构的引用计数。在子进程的页面错误处理程序中，分配一个新的物理页面而不是与父进程共享页面是可以的。后者会更酷，但需要更多的实现工作。运行 mmaptest；它应该通过 mmap_test 和 fork_test。


# 解











